<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>QC Tracking Pro</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: '#3b82f6', secondary: '#64748b' },
                    boxShadow: { 'soft': '0 10px 30px -5px rgba(0, 0, 0, 0.05)', 'premium': '0 20px 50px -12px rgba(0, 0, 0, 0.1)' }
                }
            }
        }
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans Thai', sans-serif; transition: background-color 0.3s; overscroll-behavior-y: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .resizer { position: absolute; right: 0; top: 0; height: 100%; width: 6px; cursor: col-resize; user-select: none; z-index: 10; }
        .resizer:hover { background: #3b82f6; }
        .glass-morphism { backdrop-filter: blur(12px); background-color: rgba(255, 255, 255, 0.85); }
        .dark .glass-morphism { background-color: rgba(15, 23, 42, 0.85); }
        .column-drag-target { border-left: 3px solid #3b82f6 !important; background-color: rgba(59, 130, 246, 0.05); }
        .fade-up { animation: fadeUp 0.4s ease-out forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .h-dvh { height: 100dvh; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .cell-transition {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                        max-width 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                        min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                        padding 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-[#f8fafc] dark:bg-[#0f172a] text-slate-900 dark:text-slate-100 overflow-hidden text-sm">
    <div id="root" class="h-dvh w-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const safeStorageGet = (key, fallback) => {
            try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback; } catch (e) { return fallback; }
        };
        const safeStorageSet = (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {} };

        // --- GEMINI API HELPER ---
        const callGemini = async (prompt, systemInstruction) => {
            const apiKey = ""; // Runtime provides API key
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };
            
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
                } catch (error) {
                    if (i === delays.length) throw error;
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        };

        const USER_PINS = { "2098": "Thanachot J.", "0843": "Sangdao T.", "2149": "Vinit R.", "9999": "Admin" };
        const emptyForm = { year: '', inputDate: '', refNo: '', type: '', description: '', assignment: '', documentRevised: '', effectiveDate: '', dueTarget: '', completedDate: '', owner: '', status: 'On progress', remark: '', noOfDocument: 0 };
        
        const initialColumns = [
            { id: 'action', label: 'Actions', width: 90 },
            { id: 'status', label: 'Status', width: 140 },
            { id: 'noOfDocument', label: 'No. of Document', width: 140 },
            { id: 'refNo', label: 'Ref No.', width: 130 },
            { id: 'type', label: 'Type', width: 100 },
            { id: 'description', label: 'Description', width: 250 },
            { id: 'assignment', label: 'Assignment', width: 250 },
            { id: 'dueTarget', label: 'Due Date', width: 130 },
            { id: 'completedDate', label: 'Completed Date', width: 130 },
            { id: 'owner', label: 'Owner', width: 160 },
            { id: 'year', label: 'Year', width: 80 },
            { id: 'remark', label: 'Remark', width: 200 }
        ];

        const Icons = {
            Dashboard: () => <svg className="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>,
            Tasks: () => <svg className="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2" /></svg>,
            Activity: () => <svg className="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            User: () => <svg className="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7" /></svg>,
            Theme: (dark) => dark ? <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3" /></svg> : <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
            Edit: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536M9 11l3 3L22 4" /></svg>,
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7" /></svg>,
            Plus: () => <svg className="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v12M6 12h12" /></svg>,
            Search: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
            Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            Upload: () => <svg className="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4" /></svg>,
            Save: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>,
            X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>,
            View: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            Calendar: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
            Chat: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>,
            Send: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
            Sort: ({ dir }) => (
                <div className="flex flex-col ml-1 opacity-50 group-hover:opacity-100">
                    <svg width="8" height="8" viewBox="0 0 24 24" fill={dir === 'asc' ? '#3b82f6' : 'currentColor'}><path d="m12 4 8 8H4z"/></svg>
                    <svg width="8" height="8" viewBox="0 0 24 24" fill={dir === 'desc' ? '#3b82f6' : 'currentColor'}><path d="m12 20 8-8H4z"/></svg>
                </div>
            ),
            Sparkles: () => <svg className="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
        };

        const getStatusStyles = (s) => {
            const status = s?.toLowerCase() || '';
            if (status.includes('completed')) return 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border-green-200 dark:border-green-800';
            if (status.includes('progress')) return 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 border-amber-200 dark:border-amber-800';
            if (status.includes('cancel')) return 'bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400 border-rose-200 dark:border-rose-800';
            return 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 border-blue-200 dark:border-blue-800';
        };

        const getChangesDetail = (oldData, newData) => {
            const changes = [];
            const fieldsToWatch = { status: 'Status', refNo: 'Ref No.', type: 'Type', year: 'Year', description: 'Description', assignment: 'Assignment', dueTarget: 'Due', completedDate: 'Completed', owner: 'Owner', remark: 'Remark', noOfDocument: 'No. of Doc' };
            for(let key in fieldsToWatch) {
                const oldV = String(oldData[key] || '').trim(); const newV = String(newData[key] || '').trim();
                if(oldV !== newV) changes.push(`${fieldsToWatch[key]}: '${oldV.length > 20 ? oldV.substring(0, 20) + '...' : oldV}' ‚ûî '${newV.length > 20 ? newV.substring(0, 20) + '...' : newV}'`);
            }
            return changes.join(' | ');
        };

        const firebaseConfig = {
            apiKey: "AIzaSyDDS-p_tiX88djcRCSJsnhdiOBkBmDPTb8",
            authDomain: "qc-tracking-e3d1a.firebaseapp.com",
            databaseURL: "https://qc-tracking-e3d1a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qc-tracking-e3d1a",
            storageBucket: "qc-tracking-e3d1a.firebasestorage.app",
            messagingSenderId: "598976884809",
            appId: "1:598976884809:web:7f180a0c5215d9a9d74f98"
        };

        const currentAppId = 'qc-tracking-app';
        let dbInst = null, authInst = null;
        try {
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
            dbInst = firebase.firestore(); authInst = firebase.auth();
        } catch(e) { console.error("Firebase Init Error:", e); }

        const IconLoader = () => (
            <div className="h-dvh flex items-center justify-center bg-slate-50 dark:bg-slate-900 flex-col px-4 text-center">
                <div className="w-12 h-12 border-4 border-blue-100 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                <p className="text-xs font-black uppercase text-slate-400 tracking-widest animate-pulse tracking-tighter">Connecting Infrastructure...</p>
            </div>
        );

        const EmptyState = ({ text }) => (
            <div className="flex flex-col items-center justify-center p-10 md:p-20 text-center">
                <div className="w-16 h-16 md:w-20 md:h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-slate-300 dark:text-slate-600 mb-4 animate-bounce"><Icons.Tasks /></div>
                <h4 className="text-slate-400 font-bold uppercase tracking-widest text-xs">{text || 'Infrastructure Ready'}</h4>
            </div>
        );

        const ChartComp = ({ type, data, options, isDark }) => {
            const chartRef = useRef(null); const canvasRef = useRef(null);
            useEffect(() => {
                if (chartRef.current) chartRef.current.destroy();
                if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);
                const ctx = canvasRef.current.getContext('2d');
                const defaultDataLabels = { color: type === 'doughnut' ? '#fff' : (isDark ? '#e2e8f0' : '#475569'), font: { weight: 'bold', size: 10 }, display: (context) => context.dataset.data[context.dataIndex] > 0 };
                const mergedDataLabels = options?.plugins?.datalabels ? { ...defaultDataLabels, ...options.plugins.datalabels } : defaultDataLabels;
                chartRef.current = new Chart(ctx, { type, data, options: { ...options, responsive: true, maintainAspectRatio: false, plugins: { ...options?.plugins, datalabels: mergedDataLabels, tooltip: { backgroundColor: isDark ? '#1e293b' : '#fff', titleColor: isDark ? '#fff' : '#000', bodyColor: isDark ? '#94a3b8' : '#475569', borderColor: isDark ? '#334155' : '#e2e8f0', borderWidth: 1 } } } });
            }, [data, isDark, type, options]);
            return <canvas ref={canvasRef} />;
        };

        const DashboardView = ({ tasks, isDark }) => {
            const today = new Date().toISOString().split('T')[0];
            const stats = useMemo(() => {
                const totalTasks = tasks.length;
                const totalDocs = tasks.reduce((sum, t) => sum + (parseInt(t.noOfDocument) || 0), 0);
                const completedDocs = tasks.filter(t => t.status?.toLowerCase() === 'completed').reduce((sum, t) => sum + (parseInt(t.noOfDocument) || 0), 0);
                const overdueTasks = tasks.filter(t => t.status?.toLowerCase() !== 'completed' && t.dueTarget && t.dueTarget < today).length;
                const docRate = totalDocs ? Math.round((completedDocs / totalDocs) * 100) : 0;
                return { totalTasks, totalDocs, completedDocs, overdueTasks, docRate };
            }, [tasks]);

            const { monthKeys, labels, chart1Data, chart2Data } = useMemo(() => {
                const getTaskMonth = (t) => { const d = t.inputDate || t.dueTarget || t.completedDate || ''; return (d && typeof d === 'string' && d.length >= 7) ? d.substring(0, 7) : 'Unknown'; };
                const getMonthLabel = (dateStr) => { if (dateStr === 'Unknown') return 'Unknown'; const parts = dateStr.split('-'); return parts.length < 2 ? dateStr : `${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(parts[1], 10) - 1]} ${parts[0]}`; };
                const mKeys = [...new Set(tasks.map(getTaskMonth))].sort(); const lbls = mKeys.map(getMonthLabel);
                const statusColors = { 'Completed': '#22c55e', 'On progress': '#f59e0b', 'Pending': '#3b82f6', 'Cancelled': '#f43f5e' };
                const uniqueStatuses = [...new Set(tasks.map(t => String(t.status || 'Unknown').trim()))].sort();
                
                const c1Datasets = uniqueStatuses.map(status => ({
                    label: status, backgroundColor: statusColors[status] || '#94a3b8', borderRadius: 4,
                    data: mKeys.map(mk => tasks.filter(t => getTaskMonth(t) === mk && String(t.status || '').trim() === status).reduce((sum, t) => sum + (parseInt(t.noOfDocument) || 0), 0))
                }));
                const c2Data = mKeys.map(mk => {
                    const tasksInMonth = tasks.filter(t => getTaskMonth(t) === mk);
                    const refs = new Set(tasksInMonth.map(t => String(t.refNo || '').trim()).filter(Boolean));
                    return refs.size > 0 ? refs.size : tasksInMonth.length;
                });
                return { monthKeys: mKeys, labels: lbls, chart1Data: { labels: lbls, datasets: c1Datasets }, chart2Data: { labels: lbls, datasets: [{ label: 'Total Ref No. Counts', backgroundColor: '#8b5cf6', data: c2Data, borderRadius: 6 }] } };
            }, [tasks]);

            // AI Dashboard Summary
            const [aiSummary, setAiSummary] = useState(null);
            const [isAiLoading, setIsAiLoading] = useState(false);

            const generateInsight = async () => {
                setIsAiLoading(true);
                try {
                    const pendingCount = tasks.filter(t => t.status === 'Pending').length;
                    const progressCount = tasks.filter(t => t.status === 'On progress').length;
                    const completedCount = tasks.filter(t => t.status === 'Completed').length;
                    
                    const prompt = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô QC ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${completedCount} ‡∏á‡∏≤‡∏ô, ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ ${progressCount} ‡∏á‡∏≤‡∏ô, ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ${pendingCount} ‡∏á‡∏≤‡∏ô, ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${stats.overdueTasks} ‡∏á‡∏≤‡∏ô. ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ 3-4 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ`;
                    const text = await callGemini(prompt, "You are an expert QC Project Analyst. Provide professional, concise insights. Use markdown if necessary.");
                    setAiSummary(text);
                } catch (err) {
                    setAiSummary("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å AI: " + err.message);
                }
                setIsAiLoading(false);
            };

            return (
                <div className="space-y-6 md:space-y-8 h-full overflow-y-auto custom-scrollbar pb-24 md:pb-10 px-2 md:px-4 fade-up">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                        {[{ label: 'Doc Health', val: `${stats.docRate}%`, color: 'blue', icon: 'üéØ' }, { label: 'Total Docs', val: stats.totalDocs, color: 'indigo', icon: 'üìÑ' }, { label: 'Completed Docs', val: stats.completedDocs, color: 'emerald', icon: '‚úÖ' }, { label: 'Overdue Tasks', val: stats.overdueTasks, color: 'rose', icon: 'üî•' }].map((card, i) => (
                            <div key={i} className="bg-white dark:bg-slate-800 p-5 md:p-8 rounded-[1.5rem] md:rounded-[2rem] shadow-soft border border-slate-100 dark:border-slate-700 hover:shadow-premium transition-all">
                                <div className="flex justify-between items-start mb-2 md:mb-4"><p className="text-slate-400 text-[9px] md:text-[10px] font-black uppercase tracking-widest">{card.label}</p><span className="text-lg md:text-2xl">{card.icon}</span></div>
                                <h3 className="text-2xl md:text-4xl font-black dark:text-white tracking-tighter">{card.val}</h3>
                            </div>
                        ))}
                    </div>

                    {/* Gemini AI Executive Summary Box */}
                    <div className="bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 p-6 md:p-8 rounded-[2rem] border border-indigo-100 dark:border-indigo-800/30 relative overflow-hidden group">
                        <div className="absolute -right-10 -top-10 text-indigo-500/10 dark:text-indigo-400/5 rotate-12 transition-transform group-hover:rotate-45 duration-700">
                            <Icons.Sparkles />
                        </div>
                        <div className="relative z-10 flex flex-col md:flex-row gap-4 md:items-center justify-between">
                            <div>
                                <h3 className="font-black text-indigo-800 dark:text-indigo-300 text-sm md:text-base flex items-center gap-2 mb-2"><Icons.Sparkles /> AI Executive Summary</h3>
                                <p className="text-xs text-indigo-600 dark:text-indigo-400 max-w-2xl font-medium leading-relaxed">
                                    {aiSummary || "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≠‡∏Ç‡∏ß‡∏î‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå"}
                                </p>
                            </div>
                            <button 
                                onClick={generateInsight} 
                                disabled={isAiLoading}
                                className="shrink-0 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-2xl shadow-lg shadow-indigo-200 dark:shadow-indigo-900/20 text-xs md:text-sm flex items-center justify-center gap-2 transition-all disabled:opacity-50"
                            >
                                {isAiLoading ? <div className="w-4 h-4 border-2 border-white/30 border-t-white animate-spin rounded-full"></div> : "‚ú® Generate Report"}
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 gap-6 md:gap-8">
                        <div className="bg-white dark:bg-slate-800 p-6 md:p-8 rounded-[2rem] md:rounded-[3rem] shadow-soft border dark:border-slate-700 h-[400px] md:h-[450px] flex flex-col transition-colors">
                            <h4 className="font-black text-[12px] md:text-sm uppercase tracking-widest text-slate-600 dark:text-slate-300 mb-4 md:mb-6 flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-blue-500"></span> No. of Document By Month (Separated by Status)</h4>
                            <div className="flex-1 min-h-0"><ChartComp type="bar" data={chart1Data} options={{ scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }, plugins: { legend: { position: 'top', labels: { boxWidth: 12, font: { weight: 'bold' } } }, datalabels: { color: '#ffffff', font: { weight: '900', size: 16 }, align: 'center', anchor: 'center', display: (context) => context.dataset.data[context.dataIndex] > 0 } } }} isDark={isDark} /></div>
                        </div>
                        <div className="bg-white dark:bg-slate-800 p-6 md:p-8 rounded-[2rem] md:rounded-[3rem] shadow-soft border dark:border-slate-700 h-[400px] md:h-[450px] flex flex-col transition-colors">
                            <h4 className="font-black text-[12px] md:text-sm uppercase tracking-widest text-slate-600 dark:text-slate-300 mb-4 md:mb-6 flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-purple-500"></span> Counting Ref No. By Month</h4>
                            <div className="flex-1 min-h-0"><ChartComp type="bar" data={chart2Data} options={{ scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false }, datalabels: { color: isDark ? '#ffffff' : '#334155', font: { weight: '900', size: 18 }, align: 'end', anchor: 'end', display: (context) => context.dataset.data[context.dataIndex] > 0 } } }} isDark={isDark} /></div>
                        </div>
                    </div>
                </div>
            );
        };

        const ActivityView = ({ logs }) => (
            <div className="bg-white dark:bg-slate-800 rounded-[2rem] md:rounded-[3rem] shadow-soft border dark:border-slate-700 h-full flex flex-col p-6 md:p-10 fade-up transition-colors">
                <h3 className="font-black text-lg md:text-2xl mb-6 md:mb-8 flex items-center gap-3 md:gap-4 dark:text-white uppercase tracking-tighter"><span className="w-1.5 h-5 md:h-6 bg-rose-500 rounded-full"></span> INTERACTION LOG</h3>
                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-2 pb-20 md:pb-0">
                    {logs.length === 0 ? <div className="flex flex-col items-center justify-center p-20"><div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4"><Icons.Tasks /></div><p className="text-slate-400 font-bold">No History</p></div> : 
                        logs.map((log, i) => (
                            <div key={i} className="flex items-start gap-4 md:gap-6 p-5 md:p-6 rounded-[1.5rem] md:rounded-[2.5rem] bg-slate-50 dark:bg-slate-900/50 border dark:border-slate-700/50 hover:border-blue-500 transition-all duration-300">
                                <div className="w-10 h-10 md:w-12 md:h-12 rounded-xl md:rounded-2xl bg-blue-600 text-white flex items-center justify-center font-black text-base md:text-lg shadow-lg shadow-blue-600/20 shrink-0">{log.user?.charAt(0)}</div>
                                <div className="flex-1">
                                    <p className="font-bold text-sm md:text-base text-slate-800 dark:text-slate-200 leading-tight">{log.user} <span className="text-slate-400 font-medium mx-1 md:mx-2 italic lowercase text-xs md:text-sm">{log.action}</span> <span className="text-blue-600 dark:text-blue-400 font-black tracking-tight">{log.target}</span></p>
                                    {log.details && <div className="mt-2 text-[10px] md:text-xs text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-800 p-2 md:p-3 rounded-xl border border-slate-200 dark:border-slate-700/50 inline-block font-medium break-all">{log.details}</div>}
                                    <p className="text-[9px] md:text-[10px] text-slate-400 font-black uppercase mt-2 tracking-widest opacity-60">{new Date(log.timestamp).toLocaleString()}</p>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>
        );

        function App() {
            const [theme, setTheme] = useState(localStorage.getItem('qc_theme') || 'light');
            const [activeUser, setActiveUser] = useState(sessionStorage.getItem('qc_active_user') || null);
            const [pinInput, setPinInput] = useState('');
            const [pinError, setPinError] = useState('');
            const [currentView, setCurrentView] = useState('dashboard');
            
            const [tasks, setTasks] = useState([]);
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isProcessing, setIsProcessing] = useState(false);
            const [showMobileProfile, setShowMobileProfile] = useState(false);
            const [activeDropdown, setActiveDropdown] = useState(null); 

            // Chat States
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [unreadMsg, setUnreadMsg] = useState(false);
            const [isAiTyping, setIsAiTyping] = useState(false); // Typing Indicator for AI
            const chatEndRef = useRef(null);

            const [searchTerm, setSearchTerm] = useState('');
            const [filterYears, setFilterYears] = useState([]);
            const [filterMonths, setFilterMonths] = useState([]);
            const [filterOwners, setFilterOwners] = useState([]);
            const [filterStatuses, setFilterStatuses] = useState([]);
            const [filterTypes, setFilterTypes] = useState([]);
            const [filterOverdue, setFilterOverdue] = useState(false);
            const [excludeEmptyDue, setExcludeEmptyDue] = useState(false); 

            const [fontSize, setFontSize] = useState(localStorage.getItem('qc_table_font') || 'text-xs');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentTask, setCurrentTask] = useState(emptyForm);
            const [isEditing, setIsEditing] = useState(false);
            const [isAiDrafting, setIsAiDrafting] = useState(false); // Task Modal AI State
            
            const [colOrder, setColOrder] = useState(() => { const saved = safeStorageGet('qc_col_order_v16', null); return (Array.isArray(saved) && saved.length === initialColumns.length) ? saved : initialColumns.map(c => c.id); });
            const [colWidths, setColWidths] = useState(() => { const saved = safeStorageGet('qc_col_widths_v16', null); return (saved && typeof saved === 'object') ? saved : initialColumns.reduce((a, c) => ({...a, [c.id]: c.width}), {}); });
            const [hiddenCols, setHiddenCols] = useState(() => safeStorageGet('qc_hidden_cols_v16', []));
            const [sortConfig, setSortConfig] = useState({ key: 'createdAt', direction: 'desc' });
            const [pendingEdits, setPendingEdits] = useState({});
            
            const [importPreview, setImportPreview] = useState(null);
            const [importMode, setImportMode] = useState('append');
            const fileInputRef = useRef(null);

            const syncUserSettings = (updates) => {
                if (!activeUser || !dbInst) return;
                dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_user_settings").doc(activeUser)
                    .set(updates, { merge: true }).catch(e => console.error("Error saving layout", e));
            };

            useEffect(() => {
                if (!activeUser || !dbInst) return;
                const loadLayout = async () => {
                    try {
                        const doc = await dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_user_settings").doc(activeUser).get();
                        if (doc.exists) {
                            const d = doc.data();
                            if (d.hiddenCols) { setHiddenCols(d.hiddenCols); safeStorageSet('qc_hidden_cols_v16', d.hiddenCols); }
                            if (d.colOrder) { setColOrder(d.colOrder); safeStorageSet('qc_col_order_v16', d.colOrder); }
                            if (d.colWidths) { setColWidths(d.colWidths); safeStorageSet('qc_col_widths_v16', d.colWidths); }
                            if (d.fontSize) { setFontSize(d.fontSize); localStorage.setItem('qc_table_font', d.fontSize); }
                        }
                    } catch(e) { console.error("Failed to load user layout", e); }
                };
                loadLayout();
            }, [activeUser]);

            useEffect(() => {
                if (!activeUser) return;
                let timeoutId;
                const resetTimer = () => { clearTimeout(timeoutId); timeoutId = setTimeout(() => { setActiveUser(null); sessionStorage.removeItem('qc_active_user'); }, 30 * 60 * 1000); };
                const events = ['mousemove', 'keypress', 'click', 'scroll', 'touchstart'];
                events.forEach(e => window.addEventListener(e, resetTimer)); resetTimer();
                return () => { clearTimeout(timeoutId); events.forEach(e => window.removeEventListener(e, resetTimer)); };
            }, [activeUser]);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', theme === 'dark');
                localStorage.setItem('qc_theme', theme);
            }, [theme]);

            // Database Listeners
            useEffect(() => {
                if(!dbInst) return;
                authInst.onAuthStateChanged(u => { if(!u) authInst.signInAnonymously(); });
                
                const unsubTasks = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_tasks")
                    .onSnapshot(snap => { setTasks(snap.docs.map(d => ({ id: d.id, ...d.data() }))); setLoading(false); });
                    
                const unsubLogs = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_activity")
                    .orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => setLogs(snap.docs.map(d => d.data())));

                const unsubChat = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_chat")
                    .orderBy('timestamp', 'asc').limitToLast(100)
                    .onSnapshot(snap => {
                        const messages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        setChatMessages(messages);
                        
                        if (messages.length > 0) {
                            const lastMsg = messages[messages.length - 1];
                            if (lastMsg.user !== activeUser && !isChatOpen) {
                                setUnreadMsg(true);
                            }
                        }
                    });

                return () => { unsubTasks(); unsubLogs(); unsubChat(); }
            }, [activeUser, isChatOpen]);

            // Auto-scroll Chat
            useEffect(() => {
                if (isChatOpen && chatEndRef.current) {
                    chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
                    setUnreadMsg(false);
                }
            }, [chatMessages, isChatOpen, isAiTyping]);

            const logActivity = async (action, target, user, details = "") => {
                if(!dbInst) return;
                try { await dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_activity").add({ action, target, user, details, timestamp: Date.now() }); } catch(e){}
            };

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!chatInput.trim() || !dbInst) return;
                const text = chatInput.trim();
                setChatInput('');

                // 1. Save normal message
                await dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_chat").add({
                    text,
                    user: activeUser,
                    timestamp: Date.now()
                });

                // 2. Intercept @ai keyword
                if (text.toLowerCase().includes('@ai')) {
                    setIsAiTyping(true);
                    try {
                        const activeTasks = tasks.length;
                        const completed = tasks.filter(t => t.status === 'Completed').length;
                        const aiPrompt = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${activeTasks} ‡∏á‡∏≤‡∏ô, ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ${completed} ‡∏á‡∏≤‡∏ô. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "${text.replace(/@ai/gi, '').trim()}"`;
                        
                        const aiResponse = await callGemini(aiPrompt, "You are a helpful QC AI Assistant working in the chat. Reply in Thai, be concise, helpful, and friendly.");
                        
                        await dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_chat").add({
                            text: aiResponse, 
                            user: "‚ú® AI Assistant", 
                            timestamp: Date.now()
                        });
                    } catch(err) {
                        console.error("AI Error:", err);
                    } finally {
                        setIsAiTyping(false);
                    }
                }
            };

            // AI Task Drafter
            const handleAiDraft = async () => {
                setIsAiDrafting(true);
                try {
                    const prompt = `‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô (Scope Description) ‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û 1-2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô QC ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó '${currentTask.type || '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}' ‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á '${currentTask.refNo || '-'}'`;
                    const text = await callGemini(prompt, "You are a helpful QC Management assistant. Reply only with the drafted description in Thai. Avoid markdown asterisks.");
                    setCurrentTask({...currentTask, description: text.trim().replace(/^"|"$/g, '')});
                } catch(e) { console.error("Drafting error", e); }
                setIsAiDrafting(false);
            };

            const handleSave = async () => {
                if(!dbInst) return;
                setIsProcessing(true);
                const coll = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_tasks");
                const data = { ...currentTask, updatedAt: Date.now(), updatedBy: activeUser };
                try {
                    if (isEditing) {
                        const { id, ...rest } = data; const oldData = tasks.find(t => t.id === id) || {}; const details = getChangesDetail(oldData, data);
                        await coll.doc(id).update(rest); logActivity("Revised", "Ref: " + (oldData.refNo || data.refNo || "Unknown"), activeUser, details);
                    } else {
                        data.createdAt = Date.now(); await coll.add(data); logActivity("Created", "Ref: " + (data.refNo || "Unknown"), activeUser, "Initiated new project.");
                    }
                    setIsModalOpen(false);
                } finally { setIsProcessing(false); }
            };

            const saveInline = async () => {
                if(!dbInst) return;
                setIsProcessing(true);
                const batch = dbInst.batch();
                const coll = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_tasks");
                
                Object.keys(pendingEdits).forEach(id => {
                    const oldData = tasks.find(t => t.id === id) || {};
                    const newData = { ...oldData, ...pendingEdits[id], updatedAt: Date.now(), updatedBy: activeUser };
                    const details = getChangesDetail(oldData, newData);
                    batch.update(coll.doc(id), newData);
                    if (details) {
                        const logRef = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_activity").doc();
                        batch.set(logRef, { action: "Quick Edited", target: "Ref: " + (oldData.refNo || newData.refNo || id), user: activeUser, details, timestamp: Date.now() });
                    }
                });
                await batch.commit(); setPendingEdits({}); setIsProcessing(false);
            };

            const handleExportCSV = () => {
                const headers = initialColumns.filter(c => !hiddenCols.includes(c.id)).map(c => c.label).join(',');
                const rows = filteredAndSortedTasks.map(t => initialColumns.filter(c => !hiddenCols.includes(c.id)).map(c => `"${String(t[c.id] || '').replace(/,/g, ' ').replace(/\n/g, ' ')}"`).join(',')).join('\n');
                const blob = new Blob(['\uFEFF' + headers + '\n' + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `QC_Tracking_Export_${new Date().toISOString().split('T')[0]}.csv`; link.click();
            };

            const toggleColVisibility = (id) => {
                setHiddenCols(prev => {
                    let updated = prev.includes(id) ? prev.filter(c => c !== id) : [...prev, id];
                    safeStorageSet('qc_hidden_cols_v16', updated);
                    syncUserSettings({ hiddenCols: updated });
                    return [...updated]; 
                });
            };

            const visibleCount = useMemo(() => colOrder.filter(id => !hiddenCols.includes(id)).length, [colOrder, hiddenCols]);

            const attachResizer = (e, colId) => {
                e.preventDefault(); e.stopPropagation();
                const th = e.target.closest('th'); const startX = e.pageX; const startWidth = th.getBoundingClientRect().width;
                const onMouseMove = (m) => { const newWidth = Math.max(60, startWidth + (m.pageX - startX)); th.style.width = `${newWidth}px`; th.style.minWidth = `${newWidth}px`; };
                const onMouseUp = () => {
                    const fw = th.getBoundingClientRect().width;
                    setColWidths(p => { const u = {...p, [colId]: fw}; safeStorageSet('qc_col_widths_v16', u); syncUserSettings({ colWidths: u }); return u; });
                    document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp);
                    th.style.width = ''; th.style.minWidth = ''; 
                };
                document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
            };

            const isDateEmpty = (val) => { if (!val) return true; const s = String(val).trim().toLowerCase(); return s === '' || s === '-' || s === 'n/a' || s === 'tbd' || s === 'none' || s === 'null' || s === 'undefined'; };
            const getMonth = (date) => { if (!date || typeof date !== 'string' || date.length < 7) return ''; return date.substring(5,7); };

            const filteredAndSortedTasks = useMemo(() => {
                const today = new Date().toISOString().split('T')[0];
                let res = tasks.filter(t => {
                    const mS = searchTerm === '' || Object.values(t).some(v => String(v).toLowerCase().includes(searchTerm.toLowerCase()));
                    const mY = filterYears.length === 0 || filterYears.includes(String(t.year || '').trim());
                    const mO = filterOwners.length === 0 || filterOwners.includes(String(t.owner || '').trim());
                    const mST = filterStatuses.length === 0 || filterStatuses.includes(String(t.status || '').trim());
                    const mT = filterTypes.length === 0 || filterTypes.includes(String(t.type || '').trim());
                    const isO = String(t.status || '').toLowerCase() !== 'completed' && t.dueTarget && t.dueTarget < today;
                    const mOvr = !filterOverdue || isO; const mDue = !excludeEmptyDue || !isDateEmpty(t.dueTarget); 
                    const tMo = filterMonths.length === 0 || (t.dueTarget && filterMonths.includes(getMonth(t.dueTarget))) || (t.completedDate && filterMonths.includes(getMonth(t.completedDate))) || (t.inputDate && filterMonths.includes(getMonth(t.inputDate)));
                    return mS && mY && mO && mST && mT && mOvr && tMo && mDue;
                });
                if (sortConfig.key) {
                    res.sort((a,b) => {
                        const vA = String(a[sortConfig.key] || ''); const vB = String(b[sortConfig.key] || '');
                        if (vA < vB) return sortConfig.direction === 'asc' ? -1 : 1; if (vA > vB) return sortConfig.direction === 'asc' ? 1 : -1; return 0;
                    });
                }
                return res;
            }, [tasks, searchTerm, filterYears, filterMonths, filterOwners, filterStatuses, filterTypes, filterOverdue, excludeEmptyDue, sortConfig]);

            const uniqueYears = useMemo(() => [...new Set(tasks.map(t => String(t.year || '').trim()))].filter(Boolean).sort(), [tasks]);
            const uniqueOwners = useMemo(() => [...new Set(tasks.map(t => String(t.owner || '').trim()))].filter(Boolean).sort(), [tasks]);
            const uniqueStatuses = useMemo(() => [...new Set(tasks.map(t => String(t.status || '').trim()))].filter(Boolean).sort(), [tasks]);
            const uniqueTypes = useMemo(() => [...new Set(tasks.map(t => String(t.type || '').trim()))].filter(Boolean).sort(), [tasks]);
            const monthList = [{v:'01',n:'Jan'}, {v:'02',n:'Feb'}, {v:'03',n:'Mar'}, {v:'04',n:'Apr'}, {v:'05',n:'May'}, {v:'06',n:'Jun'}, {v:'07',n:'Jul'}, {v:'08',n:'Aug'}, {v:'09',n:'Sep'}, {v:'10',n:'Oct'}, {v:'11',n:'Nov'}, {v:'12',n:'Dec'}];
            const existingRefNos = useMemo(() => new Set(tasks.map(t => String(t.refNo || '').trim()).filter(Boolean)), [tasks]);
            const overlappingCount = importPreview ? importPreview.filter(r => r.refNo && existingRefNos.has(r.refNo)).length : 0;

            const renderFilterDropdown = (id, label, options, selectedArr, setArr, icon = null) => {
                const isOpen = activeDropdown === id;
                const toggle = (val) => { const strVal = String(val).trim(); if (selectedArr.includes(strVal)) setArr(selectedArr.filter(v => v !== strVal)); else setArr([...selectedArr, strVal]); };
                const displayLabel = selectedArr.length === 0 ? `${label}: All` : `${label}: ${selectedArr.length}`;
                return (
                    <div className="relative shrink-0">
                        <button onClick={(e) => { e.stopPropagation(); setActiveDropdown(isOpen ? null : id); }} className={`flex items-center gap-2 px-3 py-2 rounded-xl border text-[10px] md:text-[11px] font-bold outline-none transition-all ${selectedArr.length > 0 ? 'bg-blue-50 border-blue-200 text-blue-600 dark:bg-blue-900/30 dark:border-blue-800 dark:text-blue-400' : 'bg-white dark:bg-slate-800 border-transparent dark:border-slate-700 text-slate-700 dark:text-white hover:border-slate-300'}`}>{icon}{displayLabel}</button>
                        {isOpen && (
                            <div className="absolute left-0 mt-2 w-48 bg-white dark:bg-slate-800 border dark:border-slate-700 shadow-xl rounded-xl p-3 z-50 animate-in fade-in" onClick={e => e.stopPropagation()}>
                                <div className="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                                    {options.map(opt => {
                                        const val = typeof opt === 'object' ? opt.v : opt; const name = typeof opt === 'object' ? opt.n : opt;
                                        return (
                                            <label key={val} className="flex items-center gap-3 p-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg cursor-pointer">
                                                <input type="checkbox" checked={selectedArr.includes(String(val).trim())} onChange={() => toggle(val)} className="w-4 h-4 rounded text-blue-600 bg-slate-100 border-slate-300 focus:ring-blue-500 cursor-pointer" />
                                                <span className="text-xs font-bold text-slate-700 dark:text-slate-300 truncate">{name}</span>
                                            </label>
                                        );
                                    })}
                                </div>
                                {selectedArr.length > 0 && <button onClick={() => setArr([])} className="w-full mt-2 pt-2 border-t dark:border-slate-700 text-[10px] text-rose-500 hover:text-rose-600 font-bold text-center uppercase tracking-widest transition-colors">Clear All</button>}
                            </div>
                        )}
                    </div>
                );
            };

            if (loading) return <IconLoader />;

            if (!activeUser) return (
                <div className="h-dvh w-full flex bg-[#f1f5f9] dark:bg-[#020617] transition-colors duration-500">
                    <div className="hidden lg:flex w-1/2 bg-blue-600 p-24 flex-col justify-between text-white relative overflow-hidden shadow-2xl">
                        <div className="z-10"><h1 className="text-7xl font-black italic tracking-tighter uppercase">QC TRACKING</h1><p className="text-blue-100 opacity-60 text-xl mt-6">Professional Intelligence & Project Management.</p></div>
                        <div className="absolute top-0 right-0 w-[600px] h-[600px] bg-blue-400 rounded-full blur-[180px] opacity-20 -mr-64 -mt-64"></div>
                    </div>
                    <div className="w-full lg:w-1/2 flex items-center justify-center p-6 md:p-8">
                        <div className="bg-white dark:bg-slate-800 p-10 md:p-16 rounded-[3rem] md:rounded-[4rem] shadow-premium w-full max-w-md border dark:border-slate-700 fade-up">
                            <h2 className="text-xl md:text-2xl font-black dark:text-white text-center mb-8 md:mb-10 uppercase tracking-widest tracking-tighter">Verify PIN</h2>
                            <form onSubmit={e => { 
                                e.preventDefault(); 
                                if(USER_PINS[pinInput]) { setActiveUser(USER_PINS[pinInput]); sessionStorage.setItem('qc_active_user', USER_PINS[pinInput]); setPinError(''); } else { setPinError('‡∏£‡∏´‡∏±‡∏™ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!'); } 
                            }} className="space-y-6 md:space-y-8">
                                <input type="password" value={pinInput} onChange={e => { setPinInput(e.target.value); setPinError(''); }} placeholder="‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢" className="w-full text-center text-4xl md:text-6xl tracking-widest py-6 md:py-8 rounded-[1.5rem] md:rounded-[2rem] dark:bg-slate-900 border-0 focus:ring-4 focus:ring-blue-500/20 outline-none dark:text-white shadow-inner bg-slate-50 transition-all" maxLength={4} autoFocus />
                                {pinError && <p className="text-rose-500 text-center font-bold text-xs md:text-sm animate-pulse">{pinError}</p>}
                                <button className="w-full bg-blue-600 py-5 md:py-6 rounded-2xl md:rounded-3xl text-white font-black shadow-xl hover:bg-blue-700 active:scale-95 transition-all uppercase tracking-widest text-xs md:text-sm">AUTHENTICATE</button>
                            </form>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col md:flex-row h-dvh w-full bg-[#f8fafc] dark:bg-[#0f172a] transition-colors duration-300" onClick={() => { setActiveDropdown(null); if(showMobileProfile) setShowMobileProfile(false); }}>
                    
                    <aside className="hidden md:flex w-72 bg-white dark:bg-[#0f172a] border-r dark:border-slate-800 flex-col z-50">
                        <div className="p-8 font-black text-2xl italic text-blue-600 tracking-tighter uppercase">QC TRACKING</div>
                        <nav className="flex-1 px-4 space-y-2">
                            {[{ id: 'dashboard', label: 'Overview', icon: <Icons.Dashboard /> }, { id: 'tasks', label: 'Projects', icon: <Icons.Tasks /> }, { id: 'activity', label: 'History Log', icon: <Icons.Activity /> }].map(item => (
                                <button key={item.id} onClick={() => setCurrentView(item.id)} className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold transition-all duration-300 ${currentView === item.id ? 'bg-blue-600 text-white shadow-xl shadow-blue-600/30' : 'text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800'}`}>
                                    {item.icon} {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-6">
                            <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-[2rem] text-center border dark:border-slate-700">
                                <p className="font-bold dark:text-white text-xs mb-4 truncate uppercase tracking-widest">{activeUser}</p>
                                <div className="flex gap-2">
                                    <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} className="flex-1 p-3 bg-white dark:bg-slate-700 rounded-xl shadow-sm hover:bg-slate-50 flex justify-center transition-colors">{Icons.Theme(theme === 'dark')}</button>
                                    <button onClick={() => { setActiveUser(null); sessionStorage.removeItem('qc_active_user'); }} className="flex-1 p-3 bg-white dark:bg-slate-700 rounded-xl shadow-sm text-rose-500 hover:bg-rose-50 flex justify-center transition-colors"><Icons.Logout /></button>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden relative pb-16 md:pb-0">
                        <header className="glass-morphism border-b dark:border-slate-800 z-40 px-4 md:px-10 py-4 md:py-6 transition-colors">
                            <div className="flex items-start md:items-center justify-between mb-4 flex-col md:flex-row gap-4">
                                <h1 className="text-xl md:text-2xl font-black dark:text-white capitalize tracking-tighter">{currentView} Interface</h1>
                                <div className="flex gap-2 w-full md:w-auto overflow-x-auto hide-scroll pb-1 md:pb-0 shrink-0">
                                    <button onClick={() => { setCurrentTask(emptyForm); setIsEditing(false); setIsModalOpen(true); }} className="bg-blue-600 text-white px-4 md:px-8 py-2 md:py-3 rounded-full font-black text-[10px] md:text-xs shadow-lg flex items-center gap-1.5 hover:scale-105 active:scale-95 transition-all shrink-0">
                                        <Icons.Plus /> <span className="hidden sm:inline">ADD TASK</span><span className="sm:hidden">NEW</span>
                                    </button>
                                    <button onClick={() => fileInputRef.current?.click()} className="p-2 md:p-3 bg-white dark:bg-slate-800 rounded-full border dark:border-slate-700 shadow-sm hover:bg-slate-50 transition-all dark:text-white shrink-0"><Icons.Upload /></button>
                                    <button onClick={handleExportCSV} className="flex md:hidden items-center gap-1.5 px-4 py-2 rounded-full text-blue-600 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900/50 text-[10px] font-black shrink-0"><Icons.Download /> <span className="hidden sm:inline">EXPORT</span></button>
                                    <input type="file" className="hidden" ref={fileInputRef} onChange={e => {
                                        const f = e.target.files[0]; if(!f) return;
                                        const r = new FileReader(); r.readAsArrayBuffer(f);
                                        r.onload = (ev) => {
                                            const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                                            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
                                            setImportPreview(json.map(x => ({
                                                year: String(x['Year'] || '').trim(), refNo: String(x['Ref No.'] || '').trim(), type: String(x['Type'] || '').trim(), 
                                                description: String(x['Description'] || '').trim(), assignment: String(x['Assignment'] || '').trim(), dueTarget: String(x['Due/Target'] || '').trim(), 
                                                completedDate: String(x['Completed date'] || '').trim(), owner: String(x['Owner'] || '').trim(), status: String(x['Status'] || 'Pending').trim(), 
                                                remark: String(x['Remark'] || '').trim(), noOfDocument: parseInt(x['No.of Document']) || parseInt(x['noOfDocument']) || 0
                                            })));
                                        };
                                    }} />
                                </div>
                            </div>

                            <div className="relative z-40 flex flex-wrap items-center gap-2 md:gap-3 pt-3 border-t dark:border-slate-800 transition-colors pb-2">
                                <div className="relative group shrink-0">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 pointer-events-none"><Icons.Search /></div>
                                    <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Search..." className="bg-slate-50 dark:bg-slate-900 py-2 pl-9 pr-4 rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500 w-36 md:w-48 dark:text-white transition-all border dark:border-slate-700" />
                                </div>
                                
                                {renderFilterDropdown('year', 'Years', uniqueYears, filterYears, setFilterYears, <Icons.Calendar />)}
                                {renderFilterDropdown('month', 'Months', monthList, filterMonths, setFilterMonths)}
                                {renderFilterDropdown('owner', 'Owners', uniqueOwners, filterOwners, setFilterOwners)}
                                {renderFilterDropdown('status', 'Statuses', uniqueStatuses, filterStatuses, setFilterStatuses)}
                                {renderFilterDropdown('type', 'Types', uniqueTypes, filterTypes, setFilterTypes)}
                                
                                <button onClick={() => setExcludeEmptyDue(!excludeEmptyDue)} className={`px-3 py-2 rounded-xl text-[10px] md:text-[11px] font-black border transition-all shrink-0 ${excludeEmptyDue ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white dark:bg-slate-800 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:text-indigo-600'}`}>
                                    {excludeEmptyDue ? 'üéØ HAS DUE ONLY' : 'üìÖ SHOW ALL'}
                                </button>
                                
                                <button onClick={() => setFilterOverdue(!filterOverdue)} className={`px-3 md:px-4 py-2 rounded-xl text-[10px] md:text-[11px] font-black transition-all border shrink-0 ${filterOverdue ? 'bg-rose-500 text-white border-rose-500 shadow-md' : 'bg-rose-50 dark:bg-rose-900/20 text-rose-500 border-rose-100 dark:border-rose-900/50 hover:bg-rose-500 hover:text-white'}`}>{filterOverdue ? 'üî• OVERDUE' : 'SHOW OVERDUE'}</button>
                                
                                {(searchTerm || filterYears.length > 0 || filterMonths.length > 0 || filterOwners.length > 0 || filterStatuses.length > 0 || filterTypes.length > 0 || filterOverdue || excludeEmptyDue) && (
                                    <button onClick={() => { setSearchTerm(''); setFilterYears([]); setFilterMonths([]); setFilterOwners([]); setFilterStatuses([]); setFilterTypes([]); setFilterOverdue(false); setExcludeEmptyDue(false); }} className="text-[10px] font-black text-slate-400 uppercase shrink-0 px-2 hover:text-slate-600 transition-colors">Clear</button>
                                )}
                                
                                <div className="ml-auto hidden md:flex items-center gap-2 shrink-0">
                                    <select value={fontSize} onChange={e => { const v = e.target.value; setFontSize(v); localStorage.setItem('qc_table_font', v); syncUserSettings({ fontSize: v }); }} className="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl px-3 py-2 text-[11px] font-bold outline-none dark:text-white">
                                        <option value="text-[10px]">Font: Small</option><option value="text-xs">Font: Medium</option><option value="text-sm">Font: Large</option>
                                    </select>
                                    
                                    <div className="relative">
                                        <button onClick={(e) => { e.stopPropagation(); setActiveDropdown(activeDropdown === 'columns' ? null : 'columns'); }} className="flex items-center gap-2 px-4 py-2 rounded-xl text-slate-500 bg-white dark:bg-slate-800 border dark:border-slate-700 text-[11px] font-black tracking-widest"><Icons.View /> COLUMNS ({visibleCount}/{initialColumns.length})</button>
                                        {activeDropdown === 'columns' && (
                                            <div className="absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 border dark:border-slate-700 shadow-xl rounded-2xl p-4 z-50 animate-in fade-in" onClick={e => e.stopPropagation()}>
                                                <p className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3 border-b dark:border-slate-700 pb-2">Toggle Visibility</p>
                                                <div className="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                                                    {initialColumns.map(col => (
                                                        <label key={col.id} className="flex items-center gap-3 p-2 hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-xl cursor-pointer">
                                                            <input type="checkbox" checked={!hiddenCols.includes(col.id)} onChange={() => toggleColVisibility(col.id)} className="w-4 h-4 text-blue-600 rounded cursor-pointer" />
                                                            <span className="text-xs font-bold text-slate-700 dark:text-slate-300">{col.label}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                                <button onClick={() => { setHiddenCols([]); setColOrder(initialColumns.map(c=>c.id)); safeStorageSet('qc_hidden_cols_v16', []); safeStorageSet('qc_col_order_v16', initialColumns.map(c=>c.id)); syncUserSettings({ hiddenCols: [], colOrder: initialColumns.map(c=>c.id) }); }} className="w-full mt-3 pt-3 border-t dark:border-slate-700 text-[10px] text-blue-500 hover:text-blue-600 font-bold text-center uppercase tracking-widest transition-colors">Reset Default</button>
                                            </div>
                                        )}
                                    </div>

                                    <button onClick={handleExportCSV} className="flex items-center gap-2 px-4 py-2 rounded-xl text-blue-600 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900/50 text-[11px] font-black tracking-widest hover:bg-blue-600 hover:text-white transition-all"><Icons.Download /> EXPORT</button>
                                </div>
                            </div>
                        </header>

                        <div className="flex-1 p-4 md:p-8 overflow-hidden">
                            {currentView === 'dashboard' && <DashboardView tasks={filteredAndSortedTasks} isDark={theme === 'dark'} />}
                            {currentView === 'activity' && <ActivityView logs={logs} />}
                            {currentView === 'tasks' && (
                                <div className="h-full flex flex-col space-y-4 fade-up">
                                    {Object.keys(pendingEdits).length > 0 && (
                                        <div className="bg-amber-50 dark:bg-amber-900/20 p-3 md:p-4 rounded-2xl md:rounded-3xl flex items-center justify-between shadow-xl border border-amber-200 dark:border-amber-900/50 flex-wrap gap-2">
                                            <div className="flex items-center gap-2 md:gap-3"><span className="px-2 py-1 md:px-3 md:py-1 bg-amber-500 text-white rounded-full font-black text-xs animate-pulse">{Object.keys(pendingEdits).length}</span><p className="font-bold text-amber-800 dark:text-amber-200 uppercase tracking-widest text-[9px] md:text-[10px]">Unsaved changes</p></div>
                                            <div className="flex gap-2"><button onClick={() => setPendingEdits({})} className="px-3 md:px-5 py-2 text-slate-500 font-bold uppercase text-[10px] md:text-xs hover:bg-amber-100 dark:hover:bg-amber-900/40 rounded-xl transition-colors">Discard</button><button onClick={saveInline} className="px-4 md:px-8 py-2 bg-amber-500 hover:bg-amber-600 text-white font-black rounded-full shadow-lg flex items-center gap-2 text-[10px] md:text-xs transition-colors"><Icons.Save /> SAVE</button></div>
                                        </div>
                                    )}

                                    <div className="md:hidden relative z-40 flex items-center justify-between bg-white dark:bg-slate-800 p-2 rounded-xl border dark:border-slate-700">
                                        <div className="relative w-full">
                                            <button onClick={(e) => { e.stopPropagation(); setActiveDropdown(activeDropdown === 'columns' ? null : 'columns'); }} className="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-slate-600 dark:text-slate-300 text-xs font-bold"><Icons.View /> Manage Columns ({visibleCount})</button>
                                            {activeDropdown === 'columns' && (
                                                <div className="absolute left-0 mt-2 w-full bg-white dark:bg-slate-800 border dark:border-slate-700 shadow-xl rounded-xl p-4 z-50" onClick={e => e.stopPropagation()}>
                                                    <div className="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto">
                                                        {initialColumns.map(col => (
                                                            <label key={col.id} className="flex items-center gap-2 p-1 cursor-pointer">
                                                                <input type="checkbox" checked={!hiddenCols.includes(col.id)} onChange={() => toggleColVisibility(col.id)} className="w-4 h-4 text-blue-600 rounded cursor-pointer" />
                                                                <span className="text-[10px] font-bold dark:text-white truncate">{col.label}</span>
                                                            </label>
                                                        ))}
                                                    </div>
                                                    <button onClick={() => { setHiddenCols([]); setColOrder(initialColumns.map(c=>c.id)); safeStorageSet('qc_hidden_cols_v16', []); safeStorageSet('qc_col_order_v16', initialColumns.map(c=>c.id)); syncUserSettings({ hiddenCols: [], colOrder: initialColumns.map(c=>c.id) }); }} className="w-full mt-3 pt-3 border-t dark:border-slate-700 text-[10px] text-blue-500 hover:text-blue-600 font-bold text-center uppercase tracking-widest transition-colors">Reset Default</button>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="bg-white dark:bg-slate-800 rounded-2xl md:rounded-[3rem] shadow-soft border dark:border-slate-700/50 overflow-hidden flex-1 flex flex-col relative pb-8 md:pb-0 z-10">
                                        <div className="overflow-x-auto custom-scrollbar flex-1">
                                            <table className={`w-full text-left border-separate border-spacing-0 table-fixed transition-colors ${fontSize}`}>
                                                <thead className="sticky top-0 z-20">
                                                    <tr className="bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700">
                                                        {colOrder.map(colId => {
                                                            const col = initialColumns.find(c => c.id === colId);
                                                            const isHidden = hiddenCols.includes(colId);
                                                            const colW = colWidths[colId] || col.width;
                                                            return (
                                                                <th key={colId} 
                                                                    className={`cell-transition relative group ${isHidden ? 'border-none' : 'px-4 py-4 md:px-8 md:py-6 text-[9px] md:text-[10px] font-black uppercase tracking-wider md:tracking-widest text-slate-400 bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700'}`}
                                                                    style={{ width: isHidden ? 0 : colW, minWidth: isHidden ? 0 : colW, maxWidth: isHidden ? 0 : colW, opacity: isHidden ? 0 : 1, paddingLeft: isHidden ? 0 : undefined, paddingRight: isHidden ? 0 : undefined }}
                                                                    draggable={!isHidden} 
                                                                    onDragStart={(e) => !isHidden && e.dataTransfer.setData("colId", colId)} 
                                                                    onDragOver={e => { if(!isHidden) { e.preventDefault(); e.currentTarget.classList.add('column-drag-target'); } }} 
                                                                    onDragLeave={e => !isHidden && e.currentTarget.classList.remove('column-drag-target')} 
                                                                    onDrop={e => { 
                                                                        if(isHidden) return;
                                                                        e.currentTarget.classList.remove('column-drag-target'); 
                                                                        const sId = e.dataTransfer.getData("colId"); 
                                                                        if(sId === colId) return; 
                                                                        const nO = [...colOrder]; const sIdx = nO.indexOf(sId); const tIdx = nO.indexOf(colId); 
                                                                        nO.splice(sIdx, 1); nO.splice(tIdx, 0, sId); 
                                                                        setColOrder(nO); safeStorageSet('qc_col_order_v16', nO); syncUserSettings({ colOrder: nO }); 
                                                                    }}>
                                                                    <div className={`transition-opacity duration-200 ${isHidden ? 'opacity-0 pointer-events-none' : 'opacity-100 flex items-center gap-1 md:gap-2 cursor-pointer hover:text-blue-500'}`} onClick={() => setSortConfig({ key: colId, direction: sortConfig.key === colId && sortConfig.direction === 'asc' ? 'desc' : 'asc' })}>
                                                                        {col.label} <Icons.Sort dir={sortConfig.key === colId ? sortConfig.direction : null} />
                                                                    </div>
                                                                    {!isHidden && <div className="resizer" onMouseDown={e => attachResizer(e, colId)} onTouchStart={e => attachResizer(e, colId)} />}
                                                                </th>
                                                            );
                                                        })}
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y dark:divide-slate-700/50">
                                                    {filteredAndSortedTasks.length === 0 ? <tr><td colSpan={initialColumns.length}><EmptyState /></td></tr> : 
                                                        filteredAndSortedTasks.map(task => {
                                                            const cD = pendingEdits[task.id] || task;
                                                            return (
                                                                <tr key={task.id} className="hover:bg-blue-50/40 dark:hover:bg-blue-900/20 transition-all group">
                                                                    {colOrder.map(colId => {
                                                                        const isHidden = hiddenCols.includes(colId);
                                                                        const colW = colWidths[colId] || initialColumns.find(c=>c.id===colId).width;
                                                                        let content = null;
                                                                        
                                                                        if (!isHidden) {
                                                                            if (colId === 'action') content = <div className="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => { setCurrentTask(task); setIsEditing(true); setIsModalOpen(true); }} className="p-2 text-blue-600 bg-white dark:bg-slate-700 md:bg-transparent hover:bg-white rounded-lg md:rounded-xl shadow-sm md:shadow-none hover:shadow-sm"><Icons.Edit /></button><button onClick={async () => { if(!dbInst) return; if(confirm(`Purge ${task.refNo}?`)) { await dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_tasks").doc(task.id).delete(); logActivity("Deleted", "Ref: " + (task.refNo || "Unknown"), activeUser, "Deleted permanently"); } }} className="p-2 text-rose-500 bg-white dark:bg-slate-700 md:bg-transparent hover:bg-white rounded-lg md:rounded-xl shadow-sm md:shadow-none hover:shadow-sm"><Icons.Trash /></button></div>;
                                                                            else if (colId === 'status') content = <select value={cD.status} onChange={e => setPendingEdits(p => ({...p, [task.id]: {...cD, status: e.target.value}}))} className={`px-2 py-1 md:px-4 md:py-2 rounded-full font-black uppercase border-0 shadow-sm outline-none cursor-pointer tracking-wider w-full ${getStatusStyles(cD.status)} ${fontSize}`}><option value="Completed">Completed</option><option value="On progress">On progress</option><option value="Pending">Pending</option><option value="Cancelled">Cancelled</option></select>;
                                                                            else if (colId === 'noOfDocument') content = <input type="number" min="0" value={cD[colId] || 0} onChange={e => setPendingEdits(p => ({...p, [task.id]: {...cD, [colId]: parseInt(e.target.value) || 0}}))} className={`bg-transparent border-0 focus:ring-0 w-full transition-all truncate outline-none ${pendingEdits[task.id] ? 'font-black text-amber-600 dark:text-amber-400' : 'font-black text-blue-600 dark:text-blue-400'} ${fontSize}`} />;
                                                                            else if (colId.includes('Date') || colId === 'dueTarget') {
                                                                                const hasVal = !isDateEmpty(cD[colId]);
                                                                                content = <input type={hasVal ? 'date' : 'text'} onFocus={e => e.target.type = 'date'} onBlur={e => { if(!e.target.value) e.target.type = 'text'; }} placeholder="-" value={hasVal ? cD[colId] : ''} onChange={e => setPendingEdits(p => ({...p, [task.id]: {...cD, [colId]: e.target.value}}))} className={`bg-transparent border-0 focus:ring-0 w-full transition-all truncate outline-none ${pendingEdits[task.id] ? 'font-black text-amber-600 dark:text-amber-400' : 'dark:text-slate-300'} ${fontSize}`} />;
                                                                            } else {
                                                                                content = <input type="text" value={cD[colId] || ''} onChange={e => setPendingEdits(p => ({...p, [task.id]: {...cD, [colId]: e.target.value}}))} className={`bg-transparent border-0 focus:ring-0 w-full transition-all truncate outline-none ${pendingEdits[task.id] ? 'font-black text-amber-600 dark:text-amber-400' : 'dark:text-slate-300'} ${fontSize}`} />;
                                                                            }
                                                                        }

                                                                        return (
                                                                            <td key={colId} 
                                                                                className={`cell-transition border-b border-transparent ${isHidden ? 'border-none' : 'px-4 md:px-8 py-3 md:py-5'}`}
                                                                                style={{ width: isHidden ? 0 : colW, maxWidth: isHidden ? 0 : colW, opacity: isHidden ? 0 : 1, paddingLeft: isHidden ? 0 : undefined, paddingRight: isHidden ? 0 : undefined }}>
                                                                                <div className={`transition-opacity duration-200 ${isHidden ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                                                                                    {content}
                                                                                </div>
                                                                            </td>
                                                                        );
                                                                    })}
                                                                </tr>
                                                            );
                                                        })
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* ---------- Floating Chat Feature ---------- */}
                    <button 
                        onClick={() => setIsChatOpen(!isChatOpen)}
                        className="fixed bottom-24 md:bottom-8 right-4 md:right-8 w-14 h-14 bg-blue-600 text-white rounded-full shadow-[0_10px_20px_rgba(37,99,235,0.4)] flex items-center justify-center hover:bg-blue-700 active:scale-95 transition-all z-[110]"
                    >
                        {isChatOpen ? <Icons.X /> : <Icons.Chat />}
                        {!isChatOpen && unreadMsg && (
                            <span className="absolute top-0 right-0 w-4 h-4 bg-rose-500 border-2 border-white dark:border-slate-900 rounded-full animate-pulse"></span>
                        )}
                    </button>

                    {isChatOpen && (
                        <div className="fixed bottom-40 md:bottom-28 right-4 md:right-8 w-[calc(100vw-2rem)] md:w-96 h-[60vh] md:h-[500px] bg-white dark:bg-slate-800 rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.2)] border dark:border-slate-700 flex flex-col z-[110] animate-in slide-in-from-bottom-5">
                            {/* Chat Header */}
                            <div className="p-4 md:p-5 border-b dark:border-slate-700 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-t-3xl flex justify-between items-center shrink-0">
                                <div>
                                    <h3 className="font-black text-base flex items-center gap-2 tracking-tight"><Icons.Chat /> Team Chat</h3>
                                    <p className="text-[10px] text-blue-100 font-medium">‚ú® ‡∏û‡∏¥‡∏°‡∏û‡πå @ai ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</p>
                                </div>
                                <button onClick={() => setIsChatOpen(false)} className="hover:bg-blue-700/50 p-2 rounded-xl transition-colors"><Icons.X /></button>
                            </div>
                            
                            {/* Chat Messages Area */}
                            <div className="flex-1 p-4 md:p-5 overflow-y-auto custom-scrollbar flex flex-col gap-4 bg-slate-50/50 dark:bg-slate-900/50">
                                {chatMessages.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center h-full text-center text-slate-400 gap-3">
                                        <div className="w-16 h-16 bg-blue-50 dark:bg-slate-800 rounded-full flex items-center justify-center text-blue-300"><Icons.Chat /></div>
                                        <div>
                                            <p className="font-bold text-xs uppercase tracking-widest text-slate-500">No Messages Yet</p>
                                            <p className="text-[10px] mt-1">Be the first to say hello!</p>
                                        </div>
                                    </div>
                                ) : (
                                    chatMessages.map((msg, index) => {
                                        const isMe = msg.user === activeUser;
                                        const isAi = msg.user === "‚ú® AI Assistant";
                                        const showHeader = index === 0 || chatMessages[index - 1].user !== msg.user;
                                        return (
                                            <div key={msg.id} className={`flex flex-col max-w-[85%] ${isMe ? 'self-end items-end' : 'self-start items-start'}`}>
                                                {showHeader && (
                                                    <span className={`text-[10px] font-bold mb-1 px-1 ${isAi ? 'text-indigo-500' : 'text-slate-400'}`}>
                                                        {isMe ? 'You' : msg.user} ‚Ä¢ {new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                    </span>
                                                )}
                                                <div className={`px-4 py-2.5 rounded-[1.2rem] text-sm shadow-sm ${
                                                    isMe 
                                                    ? 'bg-blue-600 text-white rounded-tr-sm' 
                                                    : isAi 
                                                        ? 'bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-200 dark:border-indigo-800 text-indigo-900 dark:text-indigo-100 rounded-tl-sm'
                                                        : 'bg-white dark:bg-slate-700 border dark:border-slate-600 text-slate-700 dark:text-white rounded-tl-sm'
                                                }`}>
                                                    {msg.text}
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                                
                                {/* AI Typing Indicator */}
                                {isAiTyping && (
                                    <div className="flex flex-col self-start items-start max-w-[85%] fade-up">
                                        <span className="text-[10px] text-indigo-500 font-bold mb-1 px-1">‚ú® AI Assistant is typing...</span>
                                        <div className="px-4 py-3.5 rounded-[1.2rem] shadow-sm bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-200 dark:border-indigo-800 rounded-tl-sm">
                                            <div className="flex gap-1.5 items-center">
                                                <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce"></span>
                                                <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce" style={{animationDelay: '0.15s'}}></span>
                                                <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce" style={{animationDelay: '0.3s'}}></span>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div ref={chatEndRef} />
                            </div>
                            
                            {/* Chat Input */}
                            <form onSubmit={handleSendMessage} className="p-3 md:p-4 border-t dark:border-slate-700 bg-white dark:bg-slate-800 rounded-b-3xl flex gap-2 shrink-0">
                                <input
                                    type="text"
                                    value={chatInput}
                                    onChange={e => setChatInput(e.target.value)}
                                    placeholder="Type your message... (Try @ai)"
                                    className="flex-1 bg-slate-100 dark:bg-slate-900 border border-transparent dark:border-slate-700 rounded-xl px-4 py-3 text-xs outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition-all font-medium"
                                />
                                <button 
                                    type="submit" 
                                    disabled={!chatInput.trim()} 
                                    className="w-12 h-12 bg-blue-600 text-white rounded-xl flex items-center justify-center hover:bg-blue-700 disabled:opacity-40 disabled:hover:bg-blue-600 transition-all shrink-0"
                                >
                                    <Icons.Send />
                                </button>
                            </form>
                        </div>
                    )}
                    {/* ------------------------------------------- */}

                    <nav className="md:hidden fixed bottom-0 left-0 w-full bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl border-t dark:border-slate-800 z-50 flex justify-around items-center px-2 py-2 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
                        {[ { id: 'dashboard', label: 'Overview', icon: <Icons.Dashboard /> }, { id: 'tasks', label: 'Projects', icon: <Icons.Tasks /> }, { id: 'activity', label: 'History', icon: <Icons.Activity /> } ].map(item => (
                            <button key={item.id} onClick={() => {setCurrentView(item.id); setShowMobileProfile(false); setActiveDropdown(null);}} className={`flex flex-col items-center gap-1 p-2 w-16 rounded-xl transition-all ${currentView === item.id && !showMobileProfile ? 'text-blue-600 dark:text-blue-400' : 'text-slate-400 dark:text-slate-500'}`}>
                                {item.icon} <span className="text-[9px] font-bold">{item.label}</span>
                            </button>
                        ))}
                        <button onClick={() => setShowMobileProfile(!showMobileProfile)} className={`flex flex-col items-center gap-1 p-2 w-16 rounded-xl transition-all ${showMobileProfile ? 'text-blue-600 dark:text-blue-400' : 'text-slate-400 dark:text-slate-500'}`}>
                            <Icons.User /> <span className="text-[9px] font-bold">Profile</span>
                        </button>
                    </nav>

                    {showMobileProfile && (
                        <div className="md:hidden fixed bottom-20 left-4 right-4 bg-white dark:bg-slate-800 rounded-3xl shadow-premium border dark:border-slate-700 p-6 z-50 animate-in slide-in-from-bottom-10">
                            <div className="flex items-center gap-4 mb-6 pb-4 border-b dark:border-slate-700">
                                <div className="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-black text-xl">{activeUser?.charAt(0)}</div>
                                <div><p className="font-black dark:text-white text-lg">{activeUser}</p><p className="text-xs text-slate-500">Active Session</p></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} className="flex flex-col items-center justify-center gap-2 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-2xl dark:text-white font-bold text-xs"><div className="text-blue-500">{Icons.Theme(theme === 'dark')}</div> Toggle Theme</button>
                                <button onClick={() => { setActiveUser(null); sessionStorage.removeItem('qc_active_user'); }} className="flex flex-col items-center justify-center gap-2 p-4 bg-rose-50 dark:bg-rose-900/20 text-rose-600 rounded-2xl font-bold text-xs"><Icons.Logout /> Sign Out</button>
                            </div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 md:p-6 bg-slate-950/70 backdrop-blur-md animate-in fade-in">
                            <div className="bg-white dark:bg-slate-800 rounded-[2rem] md:rounded-[4rem] shadow-premium w-full max-w-5xl max-h-[85vh] md:max-h-[92vh] flex flex-col overflow-hidden border dark:border-slate-700">
                                <div className="px-6 py-5 md:px-12 md:py-8 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50 shrink-0">
                                    <div><h2 className="text-lg md:text-3xl font-black uppercase tracking-tighter dark:text-white leading-tight">{isEditing ? 'Revise Task' : 'New Project Initiation'}</h2><p className="text-slate-400 font-medium text-[10px] md:text-xs mt-1 hidden md:block">Please provide comprehensive data.</p></div>
                                    <button onClick={() => setIsModalOpen(false)} className="p-3 md:p-4 bg-white dark:bg-slate-700 rounded-full shadow-sm hover:bg-slate-100"><Icons.X /></button>
                                </div>
                                <div className="p-6 md:p-12 overflow-y-auto custom-scrollbar grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                                    <div className="col-span-full flex flex-wrap gap-2 md:gap-4 p-2 bg-slate-100 dark:bg-slate-900 rounded-[1.5rem] md:rounded-[2.5rem] mb-2">
                                        {['On progress', 'Completed', 'Pending', 'Cancelled'].map(st => (
                                            <button key={st} onClick={() => setCurrentTask({...currentTask, status: st})} className={`flex-1 py-3 md:py-4 rounded-[1rem] md:rounded-[2rem] font-black text-[9px] md:text-[10px] uppercase tracking-widest transition-all ${currentTask.status === st ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 dark:text-slate-400 hover:bg-white dark:hover:bg-slate-800'}`}>{st}</button>
                                        ))}
                                    </div>
                                    <div className="space-y-1"><label className="text-[9px] md:text-[10px] font-black uppercase text-slate-400 ml-3">Ref No.</label><input type="text" value={currentTask.refNo} onChange={e => setCurrentTask({...currentTask, refNo: e.target.value})} className="w-full px-5 py-3 md:px-8 md:py-4 rounded-2xl md:rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-2 focus:ring-blue-500 font-bold dark:text-white outline-none shadow-inner" /></div>
                                    <div className="space-y-1"><label className="text-[9px] md:text-[10px] font-black uppercase text-blue-600 ml-3">No. of Document</label><input type="number" min="0" value={currentTask.noOfDocument || 0} onChange={e => setCurrentTask({...currentTask, noOfDocument: parseInt(e.target.value) || 0})} className="w-full px-5 py-3 md:px-8 md:py-4 rounded-2xl md:rounded-[2rem] bg-blue-50/50 dark:bg-blue-900/20 border-2 border-blue-100 dark:border-blue-900/50 focus:ring-2 focus:ring-blue-500 font-black text-lg text-blue-600 dark:text-blue-400 outline-none shadow-inner" /></div>
                                    <div className="space-y-1"><label className="text-[9px] md:text-[10px] font-black uppercase text-slate-400 ml-3">Category (Type)</label><input type="text" value={currentTask.type} onChange={e => setCurrentTask({...currentTask, type: e.target.value})} className="w-full px-5 py-3 md:px-8 md:py-4 rounded-2xl md:rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-2 focus:ring-blue-500 font-bold dark:text-white outline-none shadow-inner" /></div>
                                    <div className="space-y-1"><label className="text-[9px] md:text-[10px] font-black uppercase text-slate-400 ml-3">Fiscal Year</label><input type="text" value={currentTask.year} onChange={e => setCurrentTask({...currentTask, year: e.target.value})} className="w-full px-5 py-3 md:px-8 md:py-4 rounded-2xl md:rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-2 focus:ring-blue-500 font-bold dark:text-white outline-none shadow-inner" /></div>
                                    
                                    <div className="col-span-full space-y-1">
                                        <div className="flex items-center justify-between ml-3">
                                            <label className="text-[9px] md:text-[10px] font-black uppercase text-slate-400">Scope Description</label>
                                            <button onClick={handleAiDraft} disabled={isAiDrafting} className="text-[10px] md:text-xs text-indigo-500 font-black hover:text-indigo-600 flex items-center gap-1 transition-all">
                                                {isAiDrafting ? <span className="w-3 h-3 border border-indigo-500 border-t-transparent rounded-full animate-spin"></span> : <Icons.Sparkles />} AI Draft
                                            </button>
                                        </div>
                                        <textarea rows="2" value={currentTask.description} onChange={e => setCurrentTask({...currentTask, description: e.target.value})} className="w-full px-5 py-3 md:px-8 md:py-4 rounded-2xl md:rounded-[2.5rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-2 focus:ring-blue-500 font-medium dark:text-white outline-none shadow-inner text-xs md:text-sm" />
                                    </div>
                                    
                                    <div className="col-span-full space-y-1"><label className="text-[9px] md:text-[10px] font-black uppercase text-slate-400 ml-3">Lead Assignment</label><textarea rows="2" value={currentTask.assignment} onChange={e => setCurrentTask({...currentTask, assignment: e.target.value})} className="w-full px-5 py-3 md:px-8 md:py-4 rounded-2xl md:rounded-[2.5rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-2 focus:ring-blue-500 font-medium dark:text-white outline-none shadow-inner text-xs md:text-sm" /></div>
                                    <div className="space-y-1"><label className="text-[9px] md:text-[10px] font-black uppercase text-rose-500 ml-3">Target Due Date</label><input type={!isDateEmpty(currentTask.dueTarget) ? 'date' : 'text'} onFocus={e => e.target.type='date'} onBlur={e => {if(!e.target.value) e.target.type='text'}} placeholder="Not specified" value={!isDateEmpty(currentTask.dueTarget) ? currentTask.dueTarget : ''} onChange={e => setCurrentTask({...currentTask, dueTarget: e.target.value})} className="w-full px-5 py-3 md:px-8 md:py-4 rounded-2xl md:rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-2 focus:ring-rose-500/50 font-bold dark:text-white outline-none shadow-inner text-xs md:text-sm" /></div>
                                    <div className="space-y-1"><label className="text-[9px] md:text-[10px] font-black uppercase text-emerald-500 ml-3">Completed Date</label><input type={!isDateEmpty(currentTask.completedDate) ? 'date' : 'text'} onFocus={e => e.target.type='date'} onBlur={e => {if(!e.target.value) e.target.type='text'}} placeholder="Not specified" value={!isDateEmpty(currentTask.completedDate) ? currentTask.completedDate : ''} onChange={e => setCurrentTask({...currentTask, completedDate: e.target.value})} className="w-full px-5 py-3 md:px-8 md:py-4 rounded-2xl md:rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-2 focus:ring-emerald-500/50 font-bold dark:text-white outline-none shadow-inner text-xs md:text-sm" /></div>
                                    <div className="space-y-1"><label className="text-[9px] md:text-[10px] font-black uppercase text-slate-400 ml-3">Owner / PIC</label><input type="text" value={currentTask.owner} onChange={e => setCurrentTask({...currentTask, owner: e.target.value})} className="w-full px-5 py-3 md:px-8 md:py-4 rounded-2xl md:rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-2 focus:ring-blue-500 font-bold dark:text-white outline-none shadow-inner" /></div>
                                    <div className="col-span-full space-y-1"><label className="text-[9px] md:text-[10px] font-black uppercase text-slate-400 ml-3">Remarks</label><input type="text" value={currentTask.remark} onChange={e => setCurrentTask({...currentTask, remark: e.target.value})} className="w-full px-5 py-3 md:px-8 md:py-4 rounded-2xl md:rounded-[2.5rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-2 focus:ring-blue-500 dark:text-white outline-none shadow-inner text-xs md:text-sm" /></div>
                                </div>
                                <div className="p-6 md:p-10 border-t dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex justify-end gap-3 md:gap-6 shrink-0">
                                    <button onClick={() => setIsModalOpen(false)} className="px-6 md:px-10 py-3 font-black text-slate-400 uppercase text-[10px] md:text-xs">Abort</button>
                                    <button onClick={handleSave} disabled={isProcessing} className="bg-blue-600 text-white px-8 md:px-14 py-3 md:py-4 rounded-full font-black shadow-lg hover:bg-blue-700 active:scale-95 transition-all text-[10px] md:text-xs flex items-center gap-2">
                                        {isProcessing ? <div className="w-4 h-4 border-2 border-white/30 border-t-white animate-spin rounded-full"></div> : <Icons.Save />} COMMIT
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {importPreview && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md animate-in fade-in">
                            <div className="bg-white dark:bg-slate-800 rounded-[2rem] md:rounded-[4rem] w-full max-w-4xl p-6 md:p-12 shadow-premium flex flex-col max-h-[85vh] border dark:border-slate-700">
                                <h2 className="text-xl md:text-4xl font-black dark:text-white mb-2 md:mb-3 tracking-tighter uppercase">Review Stream</h2>
                                <p className="text-slate-400 text-xs md:text-sm font-medium mb-6">Identified <span className="text-blue-500 font-black tracking-tight">{importPreview.length}</span> records.</p>
                                
                                {overlappingCount > 0 && (
                                    <div className="mb-4 md:mb-6 p-4 md:p-5 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-900/50 rounded-2xl">
                                        <p className="font-bold text-amber-800 dark:text-amber-400 mb-2 uppercase text-[9px] md:text-[10px]">‚ö†Ô∏è {overlappingCount} Overlapping Ref No.</p>
                                        <div className="flex flex-col gap-2">
                                            <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="importMode" value="append" checked={importMode==='append'} onChange={e=>setImportMode(e.target.value)} className="w-3 h-3 md:w-4 md:h-4 text-blue-600" /><span className="text-[10px] md:text-xs font-bold dark:text-slate-300">Append (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span></label>
                                            <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="importMode" value="overwrite" checked={importMode==='overwrite'} onChange={e=>setImportMode(e.target.value)} className="w-3 h-3 md:w-4 md:h-4 text-rose-600" /><span className="text-[10px] md:text-xs font-bold dark:text-slate-300">Overwrite (‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà Ref ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô)</span></label>
                                        </div>
                                    </div>
                                )}

                                <div className="flex-1 overflow-y-auto custom-scrollbar border dark:border-slate-700 rounded-[1.5rem] md:rounded-[2.5rem] mb-6 md:mb-10 shadow-inner bg-slate-50 dark:bg-slate-900/30">
                                    <table className="w-full text-[10px] md:text-xs text-left">
                                        <thead className="bg-slate-50 dark:bg-slate-900 sticky top-0">
                                            <tr><th className="px-4 md:px-6 py-3 md:py-4 font-black text-slate-400">Ref ID</th><th className="px-4 md:px-6 py-3 md:py-4 font-black text-slate-400">Docs</th><th className="px-4 md:px-6 py-3 md:py-4 font-black text-slate-400">Owner</th><th className="px-4 md:px-6 py-3 md:py-4 font-black text-slate-400 text-right">Status</th></tr>
                                        </thead>
                                        <tbody className="divide-y dark:divide-slate-700/50">
                                            {importPreview.slice(0, 50).map((r, i) => (
                                                <tr key={i}><td className="px-4 md:px-6 py-3 font-bold dark:text-slate-200">{r.refNo || 'N/A'}</td><td className="px-4 md:px-6 py-3 text-blue-600 font-black">{r.noOfDocument}</td><td className="px-4 md:px-6 py-3 text-slate-500 truncate max-w-[100px] md:max-w-none">{r.owner}</td><td className="px-4 md:px-6 py-3 text-slate-400 uppercase font-black text-right">{r.status}</td></tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="flex gap-3 md:gap-6 shrink-0">
                                    <button onClick={() => setImportPreview(null)} className="flex-1 py-4 md:py-6 rounded-[1.5rem] md:rounded-[2rem] bg-slate-100 dark:bg-slate-700 font-black uppercase text-[10px] md:text-xs text-slate-400">Abort</button>
                                    <button onClick={async () => {
                                        if(!dbInst) return;
                                        setIsProcessing(true); const coll = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_tasks");
                                        if (importMode === 'overwrite' && overlappingCount > 0) {
                                            const iRefs = new Set(importPreview.map(r => r.refNo).filter(Boolean));
                                            const dD = tasks.filter(t => iRefs.has(t.refNo));
                                            for (let i=0; i<dD.length; i+=500) { const b = dbInst.batch(); dD.slice(i, i+500).forEach(t => b.delete(coll.doc(t.id))); await b.commit(); }
                                        }
                                        for (let i=0; i<importPreview.length; i+=500) {
                                            const b = dbInst.batch(); importPreview.slice(i, i+500).forEach(t => b.set(coll.doc(), {...t, createdAt: Date.now(), updatedAt: Date.now(), updatedBy: activeUser})); await b.commit();
                                        }
                                        logActivity("Batch Ingestion", `${importPreview.length} rows`, activeUser, `Mode: ${importMode}`); setImportPreview(null); setIsProcessing(false);
                                    }} className="flex-[2] py-4 md:py-6 rounded-[1.5rem] md:rounded-[2rem] bg-blue-600 text-white font-black uppercase text-[10px] md:text-xs shadow-lg flex items-center justify-center gap-2">
                                        {isProcessing ? <div className="w-4 h-4 border-2 border-white/20 border-t-white animate-spin rounded-full"></div> : null} PUSH TO CLOUD
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null, errorInfo: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("QC Tracking Crashed:", error, errorInfo); this.setState({ errorInfo }); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-dvh w-full flex flex-col items-center justify-center bg-slate-900 text-white p-6">
                            <div className="bg-rose-500/10 border border-rose-500 p-6 md:p-10 rounded-[2rem] max-w-2xl w-full shadow-2xl">
                                <h2 className="text-xl md:text-2xl font-black text-rose-500 mb-4 tracking-tighter">‚ö†Ô∏è SYSTEM CRASH DETECTED</h2>
                                <p className="text-sm md:text-base text-slate-300 mb-6 font-medium">‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (Fatal Error) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</p>
                                <div className="bg-black/50 p-4 md:p-6 rounded-xl overflow-auto text-[10px] md:text-xs font-mono text-rose-300 max-h-48 md:max-h-64 border border-rose-500/30">
                                    {this.state.error && this.state.error.toString()}<br/><br/>
                                    {this.state.errorInfo && this.state.errorInfo.componentStack}
                                </div>
                                <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="mt-8 bg-rose-600 hover:bg-rose-700 active:scale-95 transition-all text-white px-6 py-4 rounded-xl font-black text-xs md:text-sm uppercase tracking-widest w-full shadow-lg">CLEAR CACHE & RELOAD</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>