<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Tracking</title>
    
    <!-- PWA Setup -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: '#3b82f6', secondary: '#64748b' },
                    boxShadow: { 'soft': '0 10px 30px -5px rgba(0, 0, 0, 0.05)', 'premium': '0 20px 50px -12px rgba(0, 0, 0, 0.1)' }
                }
            }
        }
    </script>
    
    <!-- Core Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans Thai', sans-serif; transition: background-color 0.3s; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .resizer { position: absolute; right: 0; top: 0; height: 100%; width: 4px; cursor: col-resize; user-select: none; z-index: 10; }
        .resizer:hover { background: #3b82f6; }
        .glass-morphism { backdrop-filter: blur(12px); background-color: rgba(255, 255, 255, 0.8); }
        .dark .glass-morphism { background-color: rgba(15, 23, 42, 0.8); }
        .column-drag-target { border-left: 3px solid #3b82f6 !important; background-color: rgba(59, 130, 246, 0.05); }
        .fade-up { animation: fadeUp 0.4s ease-out forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#f8fafc] dark:bg-[#0f172a] text-slate-900 dark:text-slate-100 overflow-hidden text-sm">
    <div id="root" class="h-screen w-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // =============================================================
        // 1. TOOLBOX & CONSTANTS
        // =============================================================
        const USER_PINS = { "2098": "Thanachot J.", "0843": "Sangdao T.", "2149": "Vinit R.", "9999": "Admin" };
        const emptyForm = { year: '', inputDate: '', refNo: '', type: '', description: '', assignment: '', documentRevised: '', effectiveDate: '', dueTarget: '', completedDate: '', owner: '', status: 'On progress', remark: '' };
        
        const initialColumns = [
            { id: 'action', label: 'Actions', width: 90 },
            { id: 'status', label: 'Status', width: 140 },
            { id: 'refNo', label: 'Ref No.', width: 130 },
            { id: 'type', label: 'Type', width: 100 },
            { id: 'description', label: 'Description', width: 300 },
            { id: 'assignment', label: 'Assignment', width: 300 },
            { id: 'dueTarget', label: 'Due Date', width: 130 },
            { id: 'completedDate', label: 'Completed Date', width: 130 },
            { id: 'owner', label: 'Owner', width: 160 },
            { id: 'year', label: 'Year', width: 80 },
            { id: 'remark', label: 'Remark', width: 250 }
        ];

        const Icons = {
            Dashboard: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>,
            Tasks: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2" /></svg>,
            Activity: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7" /></svg>,
            Theme: (dark) => dark ? <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3" /></svg> : <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
            Edit: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536M9 11l3 3L22 4" /></svg>,
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7" /></svg>,
            Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v12M6 12h12" /></svg>,
            Search: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
            Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            Upload: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4" /></svg>,
            Save: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>,
            X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>,
            View: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            Sort: ({ dir }) => (
                <div className="flex flex-col ml-1 opacity-50 group-hover:opacity-100">
                    <svg width="8" height="8" viewBox="0 0 24 24" fill={dir === 'asc' ? '#3b82f6' : 'currentColor'}><path d="m12 4 8 8H4z"/></svg>
                    <svg width="8" height="8" viewBox="0 0 24 24" fill={dir === 'desc' ? '#3b82f6' : 'currentColor'}><path d="m12 20 8-8H4z"/></svg>
                </div>
            )
        };

        const getStatusStyles = (s) => {
            const status = s?.toLowerCase() || '';
            if (status.includes('completed')) return 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border-green-200 dark:border-green-800';
            if (status.includes('progress')) return 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 border-amber-200 dark:border-amber-800';
            if (status.includes('cancel')) return 'bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400 border-rose-200 dark:border-rose-800';
            return 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 border-blue-200 dark:border-blue-800';
        };

        // à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸„à¸§à¸²à¸¡à¹à¸•à¸à¸•à¹ˆà¸²à¸‡à¸‚à¸­à¸‡à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ à¹€à¸žà¸·à¹ˆà¸­à¸šà¸±à¸™à¸—à¸¶à¸ History à¹à¸šà¸šà¹€à¸ˆà¸²à¸°à¸¥à¸¶à¸
        const getChangesDetail = (oldData, newData) => {
            const changes = [];
            const fieldsToWatch = { 
                status: 'Status', refNo: 'Ref No.', type: 'Type', year: 'Year',
                description: 'Description', assignment: 'Assignment', 
                dueTarget: 'Due', completedDate: 'Completed', owner: 'Owner', remark: 'Remark' 
            };
            for(let key in fieldsToWatch) {
                const oldV = String(oldData[key] || '').trim();
                const newV = String(newData[key] || '').trim();
                if(oldV !== newV) {
                    const shortOld = oldV.length > 30 ? oldV.substring(0, 30) + '...' : oldV;
                    const shortNew = newV.length > 30 ? newV.substring(0, 30) + '...' : newV;
                    changes.push(`${fieldsToWatch[key]}: '${shortOld}' âž” '${shortNew}'`);
                }
            }
            return changes.join(' | ');
        };

        // =============================================================
        // 2. FIREBASE CONFIG
        // =============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDDS-p_tiX88djcRCSJsnhdiOBkBmDPTb8",
            authDomain: "qc-tracking-e3d1a.firebaseapp.com",
            databaseURL: "https://qc-tracking-e3d1a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qc-tracking-e3d1a",
            storageBucket: "qc-tracking-e3d1a.firebasestorage.app",
            messagingSenderId: "598976884809",
            appId: "1:598976884809:web:7f180a0c5215d9a9d74f98"
        };

        const currentAppId = 'qc-tracking-app';
        let dbInst, authInst;
        try {
            const app = firebase.initializeApp(firebaseConfig);
            dbInst = firebase.firestore();
            authInst = firebase.auth();
        } catch(e) {}

        // =============================================================
        // 3. UI SUB-COMPONENTS
        // =============================================================
        const IconLoader = () => (
            <div className="h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900 flex-col">
                <div className="w-12 h-12 border-4 border-blue-100 border-t-blue-500 rounded-full animate-spin mb-4"></div>
                <p className="text-xs font-black uppercase text-slate-400 tracking-widest animate-pulse tracking-tighter">Syncing Infrastructure...</p>
            </div>
        );

        const EmptyState = ({ text }) => (
            <div className="flex flex-col items-center justify-center p-20 text-center">
                <div className="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-slate-300 dark:text-slate-600 mb-4 animate-bounce"><Icons.Tasks /></div>
                <h4 className="text-slate-400 font-bold uppercase tracking-widest text-xs">{text || 'Infrastructure Ready'}</h4>
            </div>
        );

        const ChartComp = ({ type, data, options, isDark }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);
            useEffect(() => {
                if (chartRef.current) chartRef.current.destroy();
                if (typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);
                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type, data,
                    options: {
                        ...options,
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            ...options.plugins,
                            datalabels: {
                                color: type === 'doughnut' ? '#fff' : (isDark ? '#e2e8f0' : '#475569'),
                                font: { weight: 'bold', size: 10 },
                                display: (context) => context.dataset.data[context.dataIndex] > 0
                            },
                            tooltip: { backgroundColor: isDark ? '#1e293b' : '#fff', titleColor: isDark ? '#fff' : '#000', borderColor: isDark ? '#334155' : '#e2e8f0', borderWidth: 1 }
                        }
                    }
                });
            }, [data, isDark, type]);
            return <canvas ref={canvasRef} />;
        };

        const DashboardView = ({ tasks, isDark }) => {
            const today = new Date().toISOString().split('T')[0];
            const stats = useMemo(() => {
                const total = tasks.length;
                const done = tasks.filter(t => t.status?.toLowerCase() === 'completed').length;
                const overdue = tasks.filter(t => t.status?.toLowerCase() !== 'completed' && t.dueTarget && t.dueTarget < today).length;
                return { total, done, overdue, rate: total ? Math.round((done / total) * 100) : 0 };
            }, [tasks]);

            const pieData = {
                labels: ['Completed', 'Overdue', 'In Progress'],
                datasets: [{ data: [stats.done, stats.overdue, stats.total - stats.done - stats.overdue], backgroundColor: ['#22c55e', '#f43f5e', '#3b82f6'], borderWidth: 0, hoverOffset: 12 }]
            };

            const yearCounts = tasks.reduce((acc, t) => { if(t.year) acc[t.year] = (acc[t.year] || 0) + 1; return acc; }, {});
            const sortedYears = Object.keys(yearCounts).sort();
            const barData = {
                labels: sortedYears,
                datasets: [{ label: 'Projects', data: sortedYears.map(y => yearCounts[y]), backgroundColor: '#6366f1', borderRadius: 8 }]
            };

            // Chart 3: Pending Tasks by Due Date (à¹à¸ªà¸”à¸‡à¸‡à¸²à¸™à¸„à¹‰à¸²à¸‡à¸•à¸²à¸¡à¹€à¸”à¸·à¸­à¸™à¸‚à¸­à¸‡ Due Date)
            const dueData = useMemo(() => {
                const pendingByDue = tasks.filter(t => t.status?.toLowerCase() !== 'completed' && t.dueTarget).reduce((acc, t) => {
                    const month = String(t.dueTarget).substring(0, 7); // YYYY-MM
                    if (month && month.length === 7) {
                        acc[month] = (acc[month] || 0) + 1;
                    }
                    return acc;
                }, {});
                
                const sortedDueMonths = Object.keys(pendingByDue).sort();
                
                // à¹à¸›à¸¥à¸‡ YYYY-MM à¹€à¸›à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™à¹ƒà¸«à¹‰à¸­à¹ˆà¸²à¸™à¸‡à¹ˆà¸²à¸¢à¸‚à¸¶à¹‰à¸™ (à¹€à¸Šà¹ˆà¸™ Jan 2026)
                const formatMonth = (val) => {
                    if (!val) return 'Unknown';
                    const parts = val.split('-');
                    if (parts.length < 2) return val;
                    const y = parts[0];
                    const m = parseInt(parts[1], 10);
                    const mNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    return `${mNames[m - 1]} ${y}`;
                };

                return {
                    labels: sortedDueMonths.map(formatMonth),
                    datasets: [{ 
                        label: 'Pending Tasks', 
                        data: sortedDueMonths.map(m => pendingByDue[m]), 
                        backgroundColor: '#f43f5e', 
                        borderRadius: 8 
                    }]
                };
            }, [tasks]);

            // Chart 4: Monthly Completion Trend
            const lineData = useMemo(() => {
                const mCounts = tasks.filter(t => t.status?.toLowerCase() === 'completed' && t.completedDate).reduce((acc, t) => {
                    const month = t.completedDate.substring(0, 7);
                    acc[month] = (acc[month] || 0) + 1;
                    return acc;
                }, {});
                const sortedM = Object.keys(mCounts).sort().slice(-12);
                
                const formatMonth = (val) => {
                    if (!val) return 'Unknown';
                    const parts = val.split('-');
                    if (parts.length < 2) return val;
                    const mNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    return `${mNames[parseInt(parts[1], 10) - 1]} ${parts[0]}`;
                };

                return {
                    labels: sortedM.map(formatMonth),
                    datasets: [{ label: 'Completed', data: sortedM.map(m => mCounts[m]), borderColor: '#22c55e', backgroundColor: 'rgba(34, 197, 94, 0.1)', fill: true, tension: 0.3 }]
                };
            }, [tasks]);

            return (
                <div className="space-y-8 h-full overflow-y-auto custom-scrollbar pb-10 px-2 fade-up">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 text-sm">
                        {[
                            { label: 'System Health', val: `${stats.rate}%`, color: 'blue', icon: 'ðŸŽ¯' },
                            { label: 'Total Inventory', val: stats.total, color: 'indigo', icon: 'ðŸ“' },
                            { label: 'Completed', val: stats.done, color: 'emerald', icon: 'âœ…' },
                            { label: 'Critical Overdue', val: stats.overdue, color: 'rose', icon: 'ðŸ”¥' },
                        ].map((card, i) => (
                            <div key={i} className="bg-white dark:bg-slate-800 p-8 rounded-[2rem] shadow-soft border border-slate-100 dark:border-slate-700 hover:shadow-premium transition-all">
                                <div className="flex justify-between items-start mb-4">
                                    <p className="text-slate-400 text-[10px] font-black uppercase tracking-widest">{card.label}</p>
                                    <span className="text-2xl">{card.icon}</span>
                                </div>
                                <h3 className="text-4xl font-black dark:text-white tracking-tighter">{card.val}</h3>
                            </div>
                        ))}
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="bg-white dark:bg-slate-800 p-8 rounded-[3rem] shadow-soft border dark:border-slate-700 h-80 flex flex-col transition-colors">
                            <h4 className="font-black text-xs uppercase tracking-widest text-slate-400 mb-6 italic">Status Distribution</h4>
                            <div className="flex-1 min-h-0"><ChartComp type="doughnut" data={pieData} options={{ cutout: '78%', plugins: { legend: { position: 'right' } } }} isDark={isDark} /></div>
                        </div>
                        <div className="bg-white dark:bg-slate-800 p-8 rounded-[3rem] shadow-soft border dark:border-slate-700 h-80 flex flex-col transition-colors">
                            <h4 className="font-black text-xs uppercase tracking-widest text-slate-400 mb-6 italic text-rose-500">Pending Tasks by Due Date</h4>
                            <div className="flex-1 min-h-0"><ChartComp type="bar" data={dueData} options={{ scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }} isDark={isDark} /></div>
                        </div>
                        <div className="bg-white dark:bg-slate-800 p-8 rounded-[3rem] shadow-soft border dark:border-slate-700 h-80 flex flex-col transition-colors">
                            <h4 className="font-black text-xs uppercase tracking-widest text-slate-400 mb-6 italic">Yearly Volume</h4>
                            <div className="flex-1 min-h-0"><ChartComp type="bar" data={barData} options={{ scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }} isDark={isDark} /></div>
                        </div>
                        <div className="bg-white dark:bg-slate-800 p-8 rounded-[3rem] shadow-soft border dark:border-slate-700 h-80 flex flex-col transition-colors">
                            <h4 className="font-black text-xs uppercase tracking-widest text-slate-400 mb-6 italic text-emerald-500">Monthly Completion Trend</h4>
                            <div className="flex-1 min-h-0"><ChartComp type="line" data={lineData} options={{ scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false }, datalabels: { align: 'top', color: isDark ? '#94a3b8' : '#64748b' } } }} isDark={isDark} /></div>
                        </div>
                    </div>
                </div>
            );
        };

        const ActivityView = ({ logs }) => (
            <div className="bg-white dark:bg-slate-800 rounded-[3rem] shadow-soft border dark:border-slate-700 h-full flex flex-col p-10 fade-up transition-colors">
                <h3 className="font-black text-2xl mb-8 flex items-center gap-4 dark:text-white uppercase tracking-tighter"><span className="w-1.5 h-6 bg-rose-500 rounded-full"></span> INTERACTION HISTORY</h3>
                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-2">
                    {logs.length === 0 ? <EmptyState text="Historical records empty" /> : 
                        logs.map((log, i) => (
                            <div key={i} className="flex items-start gap-6 p-6 rounded-[2.5rem] bg-slate-50 dark:bg-slate-900/50 border dark:border-slate-700/50 hover:border-blue-500 transition-all duration-300">
                                <div className="w-12 h-12 rounded-2xl bg-blue-600 text-white flex items-center justify-center font-black text-lg shadow-lg shadow-blue-600/20 shrink-0">{log.user?.charAt(0)}</div>
                                <div className="flex-1">
                                    <p className="font-bold text-slate-800 dark:text-slate-200">{log.user} <span className="text-slate-400 font-medium mx-2 italic lowercase">{log.action}</span> <span className="text-blue-600 dark:text-blue-400 font-black tracking-tight">{log.target}</span></p>
                                    {log.details && (
                                        <div className="mt-2 text-xs text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700/50 inline-block font-medium">
                                            {log.details}
                                        </div>
                                    )}
                                    <p className="text-[10px] text-slate-400 font-black uppercase mt-2 tracking-widest opacity-60">{new Date(log.timestamp).toLocaleString()}</p>
                                </div>
                            </div>
                        ))
                    }
                </div>
            </div>
        );

        // =============================================================
        // 4. MAIN APP ENGINE
        // =============================================================
        function App() {
            const [theme, setTheme] = useState(localStorage.getItem('qc_theme') || 'light');
            const [activeUser, setActiveUser] = useState(sessionStorage.getItem('qc_active_user') || null);
            const [pinInput, setPinInput] = useState('');
            const [pinError, setPinError] = useState('');
            const [currentView, setCurrentView] = useState('dashboard');
            
            const [tasks, setTasks] = useState([]);
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isProcessing, setIsProcessing] = useState(false);
            
            // Filters
            const [searchTerm, setSearchTerm] = useState('');
            const [filterYear, setFilterYear] = useState('All');
            const [filterMonth, setFilterMonth] = useState('All');
            const [filterOwner, setFilterOwner] = useState('All');
            const [filterStatus, setFilterStatus] = useState('All');
            const [filterType, setFilterType] = useState('All');
            const [filterOverdue, setFilterOverdue] = useState(false);

            // Table Interface
            const [fontSize, setFontSize] = useState(localStorage.getItem('qc_table_font') || 'text-xs');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentTask, setCurrentTask] = useState(emptyForm);
            const [isEditing, setIsEditing] = useState(false);
            const [colOrder, setColOrder] = useState(() => JSON.parse(localStorage.getItem('qc_col_order_v11')) || initialColumns.map(c => c.id));
            const [colWidths, setColWidths] = useState(() => JSON.parse(localStorage.getItem('qc_col_widths_v11')) || initialColumns.reduce((a, c) => ({...a, [c.id]: c.width}), {}));
            const [hiddenCols, setHiddenCols] = useState(() => JSON.parse(localStorage.getItem('qc_hidden_cols_v1')) || []);
            const [sortConfig, setSortConfig] = useState({ key: 'createdAt', direction: 'desc' });
            const [showColMenu, setShowColMenu] = useState(false);
            
            const [pendingEdits, setPendingEdits] = useState({});
            
            // Import States
            const [importPreview, setImportPreview] = useState(null);
            const [importMode, setImportMode] = useState('append'); // 'append' or 'overwrite'
            const fileInputRef = useRef(null);

            // Auto Logout Setup (30 Mins)
            useEffect(() => {
                if (!activeUser) return;
                let timeoutId;
                const resetTimer = () => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => { setActiveUser(null); sessionStorage.removeItem('qc_active_user'); }, 30 * 60 * 1000);
                };
                const events = ['mousemove', 'keypress', 'click', 'scroll', 'touchstart'];
                events.forEach(e => window.addEventListener(e, resetTimer));
                resetTimer();
                return () => { clearTimeout(timeoutId); events.forEach(e => window.removeEventListener(e, resetTimer)); };
            }, [activeUser]);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', theme === 'dark');
                localStorage.setItem('qc_theme', theme);
                localStorage.setItem('qc_hidden_cols_v1', JSON.stringify(hiddenCols));
                localStorage.setItem('qc_table_font', fontSize);
            }, [theme, hiddenCols, fontSize]);

            useEffect(() => {
                if(!dbInst) return;
                authInst.onAuthStateChanged(u => { if(!u) authInst.signInAnonymously(); });

                const unsubTasks = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_tasks")
                    .onSnapshot(snap => { setTasks(snap.docs.map(d => ({ id: d.id, ...d.data() }))); setLoading(false); });

                const unsubLogs = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_activity")
                    .orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => setLogs(snap.docs.map(d => d.data())));

                return () => { unsubTasks(); unsubLogs(); }
            }, []);

            // Reset import mode on new file
            useEffect(() => { setImportMode('append'); }, [importPreview]);

            const logActivity = async (action, target, user, details = "") => {
                if(!dbInst) return;
                try { await dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_activity").add({ action, target, user, details, timestamp: Date.now() }); } catch(e){}
            };

            const handleSave = async () => {
                setIsProcessing(true);
                const coll = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_tasks");
                const data = { ...currentTask, updatedAt: Date.now(), updatedBy: activeUser };
                try {
                    if (isEditing) {
                        const { id, ...rest } = data;
                        const oldData = tasks.find(t => t.id === id) || {};
                        const details = getChangesDetail(oldData, data);
                        await coll.doc(id).update(rest);
                        // à¸¢à¸¶à¸” Ref No. à¹€à¸à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸ à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸£à¸¹à¹‰à¸§à¹ˆà¸²à¹à¸à¹‰à¸—à¸µà¹ˆà¸£à¸²à¸¢à¸à¸²à¸£à¹„à¸«à¸™
                        logActivity("Revised", "Ref: " + (oldData.refNo || data.refNo || "Unknown"), activeUser, details);
                    } else {
                        data.createdAt = Date.now();
                        await coll.add(data);
                        logActivity("Created", "Ref: " + (data.refNo || "Unknown"), activeUser, "Initiated new project.");
                    }
                    setIsModalOpen(false);
                } finally { setIsProcessing(false); }
            };

            const saveInline = async () => {
                setIsProcessing(true);
                const batch = dbInst.batch();
                const coll = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_tasks");
                
                Object.keys(pendingEdits).forEach(id => {
                    const oldData = tasks.find(t => t.id === id) || {};
                    const newData = { ...oldData, ...pendingEdits[id], updatedAt: Date.now(), updatedBy: activeUser };
                    const details = getChangesDetail(oldData, newData);
                    batch.update(coll.doc(id), newData);
                    
                    if (details) {
                        const logRef = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_activity").doc();
                        // à¸¢à¸¶à¸” Ref No. à¹€à¸à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸ Log
                        batch.set(logRef, { action: "Quick Edited", target: "Ref: " + (oldData.refNo || newData.refNo || id), user: activeUser, details, timestamp: Date.now() });
                    }
                });
                await batch.commit();
                setPendingEdits({}); setIsProcessing(false);
            };

            const handleExportCSV = () => {
                const headers = initialColumns.filter(c => !hiddenCols.includes(c.id)).map(c => c.label).join(',');
                const rows = filteredAndSortedTasks.map(t => {
                    return initialColumns.filter(c => !hiddenCols.includes(c.id)).map(c => {
                        const val = String(t[c.id] || '').replace(/,/g, ' ').replace(/\n/g, ' ');
                        return val;
                    }).join(',');
                }).join('\n');
                const blob = new Blob(['\uFEFF' + headers + '\n' + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `QC_Tracking_Export_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            };

            const toggleColVisibility = (id) => setHiddenCols(p => p.includes(id) ? p.filter(c => c !== id) : [...p, id]);
            const visibleColOrder = colOrder.filter(id => !hiddenCols.includes(id));

            // Smooth Resizer Function
            const attachResizer = (e, colId) => {
                e.preventDefault(); e.stopPropagation();
                const th = e.target.closest('th');
                const startX = e.pageX;
                const startWidth = th.getBoundingClientRect().width;
                
                const onMouseMove = (moveEvent) => {
                    const newWidth = Math.max(80, startWidth + (moveEvent.pageX - startX));
                    th.style.width = `${newWidth}px`;
                    th.style.minWidth = `${newWidth}px`;
                };
                
                const onMouseUp = () => {
                    const finalWidth = th.getBoundingClientRect().width;
                    setColWidths(p => { 
                        const u = {...p, [colId]: finalWidth}; 
                        localStorage.setItem('qc_col_widths_v11', JSON.stringify(u)); 
                        return u; 
                    });
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    th.style.width = ''; th.style.minWidth = ''; // Let React state take over
                };
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };

            const filteredAndSortedTasks = useMemo(() => {
                const today = new Date().toISOString().split('T')[0];
                let res = tasks.filter(t => {
                    const mS = searchTerm === '' || Object.values(t).some(v => String(v).toLowerCase().includes(searchTerm.toLowerCase()));
                    const mY = filterYear === 'All' || String(t.year) === String(filterYear);
                    const mO = filterOwner === 'All' || t.owner === filterOwner;
                    const mST = filterStatus === 'All' || t.status === filterStatus;
                    const mT = filterType === 'All' || t.type === filterType;
                    const isO = t.status?.toLowerCase() !== 'completed' && t.dueTarget && t.dueTarget < today;
                    const mOvr = !filterOverdue || isO;
                    
                    // Month filter check (from dueTarget, completedDate or inputDate)
                    const tMo = filterMonth === 'All' || 
                        (t.dueTarget && t.dueTarget.substring(5,7) === filterMonth) || 
                        (t.completedDate && t.completedDate.substring(5,7) === filterMonth) || 
                        (t.inputDate && t.inputDate.substring(5,7) === filterMonth);

                    return mS && mY && mO && mST && mT && mOvr && tMo;
                });
                
                if (sortConfig.key) {
                    res.sort((a,b) => {
                        const vA = a[sortConfig.key] || ''; const vB = b[sortConfig.key] || '';
                        if (vA < vB) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (vA > vB) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return res;
            }, [tasks, searchTerm, filterYear, filterMonth, filterOwner, filterStatus, filterType, filterOverdue, sortConfig]);

            const uniqueYears = useMemo(() => [...new Set(tasks.map(t => t.year))].filter(Boolean).sort(), [tasks]);
            const uniqueOwners = useMemo(() => [...new Set(tasks.map(t => t.owner))].filter(Boolean).sort(), [tasks]);
            const uniqueStatuses = useMemo(() => [...new Set(tasks.map(t => t.status))].filter(Boolean).sort(), [tasks]);
            const uniqueTypes = useMemo(() => [...new Set(tasks.map(t => t.type))].filter(Boolean).sort(), [tasks]);
            const monthList = [{v:'01',n:'Jan'}, {v:'02',n:'Feb'}, {v:'03',n:'Mar'}, {v:'04',n:'Apr'}, {v:'05',n:'May'}, {v:'06',n:'Jun'}, {v:'07',n:'Jul'}, {v:'08',n:'Aug'}, {v:'09',n:'Sep'}, {v:'10',n:'Oct'}, {v:'11',n:'Nov'}, {v:'12',n:'Dec'}];

            // Import Checker
            const existingRefNos = useMemo(() => new Set(tasks.map(t => t.refNo).filter(Boolean)), [tasks]);
            const overlappingCount = importPreview ? importPreview.filter(r => r.refNo && existingRefNos.has(r.refNo)).length : 0;

            if (loading) return <IconLoader />;

            if (!activeUser) return (
                <div className="h-screen w-full flex bg-[#f1f5f9] dark:bg-[#020617] transition-colors duration-500">
                    <div className="hidden lg:flex w-1/2 bg-blue-600 p-24 flex-col justify-between text-white relative overflow-hidden shadow-2xl">
                        <div className="z-10"><h1 className="text-7xl font-black italic tracking-tighter uppercase">QC TRACKING</h1><p className="text-blue-100 opacity-60 text-xl mt-6">Secure Intelligence & Project Management.</p></div>
                        <div className="absolute top-0 right-0 w-96 h-96 bg-blue-400 rounded-full blur-[150px] opacity-20 -mr-48 -mt-48"></div>
                    </div>
                    <div className="w-full lg:w-1/2 flex items-center justify-center p-8">
                        <div className="bg-white dark:bg-slate-800 p-16 rounded-[4rem] shadow-premium w-full max-w-md border dark:border-slate-700 fade-up">
                            <h2 className="text-2xl font-black dark:text-white text-center mb-10 uppercase tracking-widest tracking-tighter">Verify PIN</h2>
                            <form onSubmit={e => { 
                                e.preventDefault(); 
                                if(USER_PINS[pinInput]) { 
                                    setActiveUser(USER_PINS[pinInput]); sessionStorage.setItem('qc_active_user', USER_PINS[pinInput]); setPinError('');
                                } else { setPinError('à¸£à¸«à¸±à¸ª PIN à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡!'); } 
                            }} className="space-y-8">
                                <input type="password" value={pinInput} onChange={e => { setPinInput(e.target.value); setPinError(''); }} placeholder="â€¢ â€¢ â€¢ â€¢" className="w-full text-center text-6xl tracking-widest py-8 rounded-[2rem] dark:bg-slate-900 border-0 focus:ring-4 focus:ring-blue-500/20 outline-none dark:text-white shadow-inner bg-slate-50 transition-all" maxLength={4} autoFocus />
                                {pinError && <p className="text-rose-500 text-center font-bold text-sm animate-pulse">{pinError}</p>}
                                <button className="w-full bg-blue-600 py-6 rounded-3xl text-white font-black shadow-xl hover:bg-blue-700 active:scale-95 transition-all uppercase tracking-widest">AUTHENTICATE</button>
                            </form>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex h-full w-full bg-[#f8fafc] dark:bg-[#0f172a] transition-colors duration-300" onClick={() => { if(showColMenu) setShowColMenu(false); }}>
                    <aside className="w-64 bg-white dark:bg-[#0f172a] border-r dark:border-slate-800 flex flex-col z-50">
                        <div className="p-8 font-black text-2xl italic text-blue-600 tracking-tighter uppercase">QC TRACKING</div>
                        <nav className="flex-1 px-4 space-y-2">
                            {[
                                { id: 'dashboard', label: 'Overview', icon: <Icons.Dashboard /> },
                                { id: 'tasks', label: 'Projects', icon: <Icons.Tasks /> },
                                { id: 'activity', label: 'History Log', icon: <Icons.Activity /> },
                            ].map(item => (
                                <button key={item.id} onClick={() => setCurrentView(item.id)} className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold transition-all duration-300 ${currentView === item.id ? 'bg-blue-600 text-white shadow-xl shadow-blue-600/30' : 'text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800'}`}>
                                    {item.icon} {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-6">
                            <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-[2rem] text-center border dark:border-slate-700">
                                <p className="font-bold dark:text-white text-xs mb-4 truncate uppercase tracking-widest">{activeUser}</p>
                                <div className="flex gap-2">
                                    <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} className="flex-1 p-3 bg-white dark:bg-slate-700 rounded-xl shadow-sm hover:bg-slate-50 flex justify-center transition-colors">{Icons.Theme(theme === 'dark')}</button>
                                    <button onClick={() => { setActiveUser(null); sessionStorage.removeItem('qc_active_user'); }} className="flex-1 p-3 bg-white dark:bg-slate-700 rounded-xl shadow-sm text-rose-500 hover:bg-rose-50 flex justify-center transition-colors"><Icons.Logout /></button>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden relative">
                        <header className="glass-morphism border-b dark:border-slate-800 z-40 px-8 py-5 transition-colors">
                            <div className="flex items-center justify-between mb-4">
                                <h1 className="text-2xl font-black dark:text-white capitalize tracking-tighter transition-colors">{currentView} Interface</h1>
                                <div className="flex gap-3">
                                    <button onClick={() => { setCurrentTask(emptyForm); setIsEditing(false); setIsModalOpen(true); }} className="bg-blue-600 text-white px-6 py-3 rounded-full font-black text-xs shadow-lg flex items-center gap-2 hover:scale-105 active:scale-95 transition-all"><Icons.Plus /> ADD TASK</button>
                                    <button onClick={() => fileInputRef.current?.click()} className="p-3 bg-white dark:bg-slate-800 rounded-full border dark:border-slate-700 shadow-sm hover:bg-slate-50 transition-all dark:text-white" title="Import Excel"><Icons.Upload /></button>
                                    <input type="file" className="hidden" ref={fileInputRef} onChange={e => {
                                        const f = e.target.files[0]; if(!f) return;
                                        const r = new FileReader(); r.readAsArrayBuffer(f);
                                        r.onload = (ev) => {
                                            const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                                            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
                                            setImportPreview(json.map(x => ({
                                                year: x['Year'] || '', refNo: x['Ref No.'] || '', type: x['Type'] || '', description: x['Description'] || '', assignment: x['Assignment'] || '', dueTarget: x['Due/Target'] || '', completedDate: x['Completed date'] || '', owner: x['Owner'] || '', status: x['Status'] || 'Pending', remark: x['Remark'] || ''
                                            })));
                                        };
                                    }} />
                                </div>
                            </div>

                            <div className="flex flex-wrap items-center gap-3 pt-3 border-t dark:border-slate-800 transition-colors">
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 pointer-events-none transition-colors"><Icons.Search /></div>
                                    <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Quick filter..." className="bg-slate-50 dark:bg-slate-900 py-2.5 pl-10 pr-4 rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500 w-48 dark:text-white transition-all shadow-inner border border-slate-100 dark:border-slate-700" />
                                </div>
                                
                                <select value={filterYear} onChange={e => setFilterYear(e.target.value)} className="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl px-3 py-2.5 text-[11px] font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"><option value="All">Year: All</option>{uniqueYears.map(y => <option key={y} value={y}>{y}</option>)}</select>
                                <select value={filterMonth} onChange={e => setFilterMonth(e.target.value)} className="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl px-3 py-2.5 text-[11px] font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"><option value="All">Month: All</option>{monthList.map(m => <option key={m.v} value={m.v}>{m.n}</option>)}</select>
                                <select value={filterOwner} onChange={e => setFilterOwner(e.target.value)} className="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl px-3 py-2.5 text-[11px] font-bold outline-none focus:ring-2 focus:ring-blue-500 max-w-[120px] dark:text-white truncate"><option value="All">Owner: All</option>{uniqueOwners.map(o => <option key={o} value={o}>{o}</option>)}</select>
                                <select value={filterStatus} onChange={e => setFilterStatus(e.target.value)} className="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl px-3 py-2.5 text-[11px] font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"><option value="All">Status: All</option>{uniqueStatuses.map(s => <option key={s} value={s}>{s}</option>)}</select>
                                <select value={filterType} onChange={e => setFilterType(e.target.value)} className="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl px-3 py-2.5 text-[11px] font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white"><option value="All">Type: All</option>{uniqueTypes.map(t => <option key={t} value={t}>{t}</option>)}</select>
                                <button onClick={() => setFilterOverdue(!filterOverdue)} className={`px-4 py-2.5 rounded-xl text-[11px] font-black transition-all border ${filterOverdue ? 'bg-rose-500 text-white border-rose-500 shadow-md' : 'bg-rose-50 dark:bg-rose-900/20 text-rose-500 border-rose-100 dark:border-rose-900/50 hover:bg-rose-500 hover:text-white'}`}>{filterOverdue ? 'ðŸ”¥ OVERDUE' : 'SHOW OVERDUE'}</button>
                                
                                {(searchTerm || filterYear !== 'All' || filterMonth !== 'All' || filterOwner !== 'All' || filterStatus !== 'All' || filterType !== 'All' || filterOverdue) && (
                                    <button onClick={() => { setSearchTerm(''); setFilterYear('All'); setFilterMonth('All'); setFilterOwner('All'); setFilterStatus('All'); setFilterType('All'); setFilterOverdue(false); }} className="text-[10px] font-black text-slate-400 uppercase hover:text-rose-500 transition-colors px-2">Reset</button>
                                )}
                                
                                <div className="ml-auto flex items-center gap-2">
                                    <select value={fontSize} onChange={e => setFontSize(e.target.value)} className="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl px-3 py-2.5 text-[11px] font-bold outline-none focus:ring-2 focus:ring-blue-500 dark:text-white">
                                        <option value="text-[10px]">Font: Small</option>
                                        <option value="text-xs">Font: Medium</option>
                                        <option value="text-sm">Font: Large</option>
                                    </select>
                                    <div className="relative" onClick={e => e.stopPropagation()}>
                                        <button onClick={() => setShowColMenu(!showColMenu)} className="flex items-center gap-2 px-4 py-2.5 rounded-xl text-slate-500 bg-white dark:bg-slate-800 border dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all text-[11px] font-black tracking-widest"><Icons.View /> COLUMNS</button>
                                        {showColMenu && (
                                            <div className="absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 border dark:border-slate-700 shadow-xl rounded-2xl p-4 z-50 animate-in fade-in">
                                                <p className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3 border-b dark:border-slate-700 pb-2">Toggle Visibility</p>
                                                <div className="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                                                    {initialColumns.map(col => (
                                                        <label key={col.id} className="flex items-center gap-3 p-2 hover:bg-slate-50 dark:hover:bg-slate-700/50 rounded-xl cursor-pointer transition-colors">
                                                            <input type="checkbox" checked={!hiddenCols.includes(col.id)} onChange={() => toggleColVisibility(col.id)} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                                                            <span className="text-xs font-bold text-slate-700 dark:text-slate-300">{col.label}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <button onClick={handleExportCSV} className="flex items-center gap-2 px-4 py-2.5 rounded-xl text-blue-600 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900/50 hover:bg-blue-600 hover:text-white transition-all text-[11px] font-black tracking-widest"><Icons.Download /> EXPORT</button>
                                </div>
                            </div>
                        </header>

                        <div className="flex-1 p-8 overflow-hidden">
                            {currentView === 'dashboard' && <DashboardView tasks={filteredAndSortedTasks} isDark={theme === 'dark'} />}
                            {currentView === 'activity' && <ActivityView logs={logs} />}
                            {currentView === 'tasks' && (
                                <div className="h-full flex flex-col space-y-4 fade-up">
                                    {Object.keys(pendingEdits).length > 0 && (
                                        <div className="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-3xl flex items-center justify-between shadow-xl border border-amber-200 dark:border-amber-900/50 animate-in slide-in-from-top-4">
                                            <div className="flex items-center gap-3"><span className="px-3 py-1 bg-amber-500 text-white rounded-full font-black animate-pulse">{Object.keys(pendingEdits).length}</span><p className="font-bold text-amber-800 dark:text-amber-200 uppercase tracking-widest text-[10px]">Unsaved changes</p></div>
                                            <div className="flex gap-3"><button onClick={() => setPendingEdits({})} className="px-5 py-2 text-slate-500 font-bold uppercase text-xs hover:text-slate-800">Discard</button><button onClick={saveInline} className="px-8 py-2 bg-amber-500 text-white font-black rounded-full shadow-lg hover:bg-amber-600 transition-all flex items-center gap-2 text-xs tracking-widest"><Icons.Save /> COMMIT UPDATES</button></div>
                                        </div>
                                    )}
                                    <div className="bg-white dark:bg-slate-800 rounded-[2rem] shadow-premium border dark:border-slate-700/50 overflow-hidden flex-1 flex flex-col relative transition-colors duration-300">
                                        <div className="overflow-x-auto custom-scrollbar flex-1">
                                            <table className={`w-full text-left border-separate border-spacing-0 table-fixed transition-colors ${fontSize}`}>
                                                <thead className="sticky top-0 z-20">
                                                    <tr className="bg-slate-50 dark:bg-slate-900 border-b dark:border-slate-700 transition-colors">
                                                        {visibleColOrder.map(colId => {
                                                            const col = initialColumns.find(c => c.id === colId);
                                                            return (
                                                                <th key={colId} style={{ width: colWidths[colId] }} className="px-6 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400 relative group transition-colors" draggable onDragStart={(e) => e.dataTransfer.setData("colId", colId)} onDragOver={e => { e.preventDefault(); e.currentTarget.classList.add('column-drag-target'); }} onDragLeave={e => e.currentTarget.classList.remove('column-drag-target')} onDrop={e => { e.currentTarget.classList.remove('column-drag-target'); const sId = e.dataTransfer.getData("colId"); if(sId === colId) return; const nO = [...colOrder]; const sIdx = nO.indexOf(sId); const tIdx = nO.indexOf(colId); nO.splice(sIdx, 1); nO.splice(tIdx, 0, sId); setColOrder(nO); localStorage.setItem('qc_col_order_v11', JSON.stringify(nO)); }}>
                                                                    <div className="flex items-center gap-2 cursor-pointer hover:text-blue-500 transition-all" onClick={() => setSortConfig({ key: colId, direction: sortConfig.key === colId && sortConfig.direction === 'asc' ? 'desc' : 'asc' })}>{col.label} <Icons.Sort dir={sortConfig.key === colId ? sortConfig.direction : null} /></div>
                                                                    <div className="resizer" onMouseDown={e => attachResizer(e, colId)} />
                                                                </th>
                                                            );
                                                        })}
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y dark:divide-slate-700/50 transition-colors">
                                                    {filteredAndSortedTasks.length === 0 ? <tr><td colSpan={visibleColOrder.length}><EmptyState /></td></tr> : 
                                                        filteredAndSortedTasks.map(task => {
                                                            const cD = pendingEdits[task.id] || task;
                                                            return (
                                                                <tr key={task.id} className="hover:bg-blue-50/40 dark:hover:bg-blue-900/20 transition-all group">
                                                                    {visibleColOrder.map(colId => {
                                                                        if (colId === 'action') return (
                                                                            <td key={colId} className="px-6 py-3"><div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => { setCurrentTask(task); setIsEditing(true); setIsModalOpen(true); }} className="p-2.5 text-blue-600 hover:bg-white dark:hover:bg-slate-700 rounded-xl shadow-sm transition-all"><Icons.Edit /></button><button onClick={async () => { if(confirm(`Purge ${task.refNo}?`)) { await dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_tasks").doc(task.id).delete(); logActivity("Deleted", "Ref: " + (task.refNo || "Unknown"), activeUser, "Deleted permanently"); } }} className="p-2.5 text-rose-500 hover:bg-white dark:hover:bg-slate-700 rounded-xl shadow-sm transition-all"><Icons.Trash /></button></div></td>
                                                                        );
                                                                        if (colId === 'status') return (
                                                                            <td key={colId} className="px-6 py-3"><select value={cD.status} onChange={e => setPendingEdits(p => ({...p, [task.id]: {...cD, status: e.target.value}}))} className={`px-3 py-1.5 rounded-full font-black uppercase border-0 shadow-sm outline-none cursor-pointer tracking-wider transition-colors w-full ${getStatusStyles(cD.status)} ${fontSize}`}><option value="Completed">Completed</option><option value="On progress">On progress</option><option value="Pending">Pending</option><option value="Cancelled">Cancelled</option></select></td>
                                                                        );
                                                                        return (
                                                                            <td key={colId} className="px-6 py-3"><input type={colId.includes('Date') || colId === 'dueTarget' ? 'date' : 'text'} value={cD[colId] || ''} onChange={e => setPendingEdits(p => ({...p, [task.id]: {...cD, [colId]: e.target.value}}))} className={`bg-transparent border-0 focus:ring-0 w-full transition-all truncate outline-none ${pendingEdits[task.id] ? 'font-black text-amber-600 dark:text-amber-400' : 'dark:text-slate-300'} ${fontSize}`} /></td>
                                                                        );
                                                                    })}
                                                                </tr>
                                                            );
                                                        })
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* MODALS */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-950/70 backdrop-blur-md animate-in fade-in transition-colors">
                            <div className="bg-white dark:bg-slate-800 rounded-[4rem] shadow-premium w-full max-w-5xl max-h-[92vh] flex flex-col overflow-hidden border dark:border-slate-700 transition-colors duration-500">
                                <div className="px-12 py-8 border-b dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                                    <h2 className="text-3xl font-black uppercase tracking-tighter dark:text-white transition-colors">{isEditing ? 'Revise Task' : 'New Project Initiation'}</h2>
                                    <button onClick={() => setIsModalOpen(false)} className="p-4 bg-white dark:bg-slate-700 rounded-full shadow-sm hover:bg-slate-100 transition-all"><Icons.X /></button>
                                </div>
                                <div className="p-12 overflow-y-auto custom-scrollbar grid grid-cols-1 md:grid-cols-3 gap-6 transition-colors">
                                    <div className="col-span-full flex gap-4 p-2 bg-slate-100 dark:bg-slate-900 rounded-[2.5rem] mb-4">
                                        {['On progress', 'Completed', 'Pending', 'Cancelled'].map(st => (
                                            <button key={st} onClick={() => setCurrentTask({...currentTask, status: st})} className={`flex-1 py-4 rounded-[2rem] font-black text-[10px] uppercase tracking-widest transition-all ${currentTask.status === st ? 'bg-blue-600 text-white shadow-xl shadow-blue-600/30' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`}>{st}</button>
                                        ))}
                                    </div>
                                    <div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 ml-3 tracking-[0.2em]">Ref No.</label><input type="text" value={currentTask.refNo} onChange={e => setCurrentTask({...currentTask, refNo: e.target.value})} className="w-full px-8 py-4 rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-4 focus:ring-blue-500/20 font-bold dark:text-white outline-none shadow-inner shadow-slate-200/50 transition-all" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 ml-3 tracking-[0.2em]">Category</label><input type="text" value={currentTask.type} onChange={e => setCurrentTask({...currentTask, type: e.target.value})} className="w-full px-8 py-4 rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-4 focus:ring-blue-500/20 font-bold dark:text-white outline-none shadow-inner shadow-slate-200/50 transition-all" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 ml-3 tracking-[0.2em]">Fiscal Year</label><input type="text" value={currentTask.year} onChange={e => setCurrentTask({...currentTask, year: e.target.value})} className="w-full px-8 py-4 rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-4 focus:ring-blue-500/20 font-bold dark:text-white outline-none shadow-inner shadow-slate-200/50 transition-all" /></div>
                                    <div className="col-span-full space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 ml-3 tracking-[0.2em]">Description</label><textarea rows="2" value={currentTask.description} onChange={e => setCurrentTask({...currentTask, description: e.target.value})} className="w-full px-8 py-4 rounded-[2.5rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-4 focus:ring-blue-500/20 font-medium dark:text-white outline-none shadow-inner shadow-slate-200/50 transition-all" /></div>
                                    <div className="col-span-full space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 ml-3 tracking-[0.2em]">Assignment</label><textarea rows="2" value={currentTask.assignment} onChange={e => setCurrentTask({...currentTask, assignment: e.target.value})} className="w-full px-8 py-4 rounded-[2.5rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-4 focus:ring-blue-500/20 font-medium dark:text-white outline-none shadow-inner shadow-slate-200/50 transition-all" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 ml-3 tracking-[0.2em] text-rose-500">Due Date</label><input type="date" value={currentTask.dueTarget} onChange={e => setCurrentTask({...currentTask, dueTarget: e.target.value})} className="w-full px-8 py-4 rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-4 focus:ring-rose-500/20 font-bold dark:text-white outline-none shadow-inner shadow-slate-200/50 transition-all" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 ml-3 tracking-[0.2em] text-emerald-500">Completed Date</label><input type="date" value={currentTask.completedDate} onChange={e => setCurrentTask({...currentTask, completedDate: e.target.value})} className="w-full px-8 py-4 rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-4 focus:ring-emerald-500/20 font-bold dark:text-white outline-none shadow-inner shadow-slate-200/50 transition-all" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 ml-3 tracking-[0.2em]">Owner</label><input type="text" value={currentTask.owner} onChange={e => setCurrentTask({...currentTask, owner: e.target.value})} className="w-full px-8 py-4 rounded-[2rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-4 focus:ring-blue-500/20 font-bold dark:text-white outline-none shadow-inner shadow-slate-200/50 transition-all" /></div>
                                    <div className="col-span-full space-y-1"><label className="text-[10px] font-black uppercase text-slate-400 ml-3 tracking-[0.2em]">Remark</label><input type="text" value={currentTask.remark} onChange={e => setCurrentTask({...currentTask, remark: e.target.value})} className="w-full px-8 py-4 rounded-[2.5rem] bg-slate-50 dark:bg-slate-900 border-0 focus:ring-4 focus:ring-blue-500/20 dark:text-white outline-none shadow-inner shadow-slate-200/50 transition-all" /></div>
                                </div>
                                <div className="p-10 border-t dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 flex justify-end gap-4 transition-colors">
                                    <button onClick={() => setIsModalOpen(false)} className="px-10 font-black text-slate-400 uppercase text-xs hover:text-slate-800 transition-colors tracking-widest">Abort</button>
                                    <button onClick={handleSave} disabled={isProcessing} className="bg-blue-600 text-white px-14 py-4 rounded-full font-black shadow-2xl shadow-blue-600/30 flex items-center gap-3 hover:bg-blue-700 active:scale-95 transition-all text-xs tracking-widest uppercase">
                                        {isProcessing ? <div className="w-4 h-4 border-2 border-white/30 border-t-white animate-spin rounded-full"></div> : <Icons.Save />} Commit Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* IMPORT MODAL WITH OVERWRITE OPTIONS */}
                    {importPreview && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md animate-in fade-in transition-colors duration-500">
                            <div className="bg-white dark:bg-slate-800 rounded-[4rem] w-full max-w-4xl p-12 shadow-premium flex flex-col max-h-[85vh] border dark:border-slate-700 transition-colors">
                                <h2 className="text-4xl font-black dark:text-white mb-3 tracking-tighter uppercase transition-colors">Review Stream</h2>
                                <p className="text-slate-400 font-medium mb-6 transition-colors">Algorithm identified <span className="text-blue-500 font-black tracking-tight">{importPreview.length}</span> records.</p>
                                
                                {overlappingCount > 0 && (
                                    <div className="mb-6 p-5 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-900/50 rounded-[2rem] transition-colors">
                                        <p className="font-bold text-amber-800 dark:text-amber-400 flex items-center gap-2 mb-3 uppercase tracking-widest text-[10px]">
                                            âš ï¸ Detected {overlappingCount} Overlapping Ref No.
                                        </p>
                                        <div className="flex flex-col gap-3">
                                            <label className="flex items-center gap-3 cursor-pointer">
                                                <input type="radio" name="importMode" value="append" checked={importMode==='append'} onChange={e=>setImportMode(e.target.value)} className="w-4 h-4 text-blue-600 focus:ring-blue-500" />
                                                <span className="text-sm font-bold dark:text-slate-300">Append (à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸›à¹‡à¸™à¸£à¸²à¸¢à¸à¸²à¸£à¹ƒà¸«à¸¡à¹ˆà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”)</span>
                                            </label>
                                            <label className="flex items-center gap-3 cursor-pointer">
                                                <input type="radio" name="importMode" value="overwrite" checked={importMode==='overwrite'} onChange={e=>setImportMode(e.target.value)} className="w-4 h-4 text-rose-600 focus:ring-rose-500" />
                                                <span className="text-sm font-bold dark:text-slate-300">Overwrite (à¸¥à¸šà¸‚à¸­à¸‡à¹€à¸”à¸´à¸¡à¸—à¸µà¹ˆ Ref No à¸•à¸£à¸‡à¸à¸±à¸™à¹à¸¥à¹‰à¸§à¹€à¸‚à¸µà¸¢à¸™à¸—à¸±à¸šà¹ƒà¸«à¸¡à¹ˆ)</span>
                                            </label>
                                        </div>
                                    </div>
                                )}

                                <div className="flex-1 overflow-y-auto custom-scrollbar border dark:border-slate-700 rounded-[2.5rem] mb-10 overflow-hidden shadow-inner bg-slate-50 dark:bg-slate-900/30 transition-colors">
                                    <table className="w-full text-xs text-left">
                                        <thead className="bg-slate-50 dark:bg-slate-900 sticky top-0 transition-colors">
                                            <tr><th className="px-6 py-4 font-black uppercase text-slate-400 tracking-widest text-xs transition-colors">Ref ID</th><th className="px-6 py-4 font-black uppercase text-slate-400 tracking-widest text-xs transition-colors">Owner</th><th className="px-6 py-4 font-black uppercase text-slate-400 tracking-widest text-right text-xs transition-colors transition-colors">Workflow</th></tr>
                                        </thead>
                                        <tbody className="divide-y dark:divide-slate-700/50">
                                            {importPreview.slice(0, 100).map((r, i) => (
                                                <tr key={i} className="transition-colors"><td className="px-6 py-4 font-bold dark:text-slate-200">{r.refNo || 'N/A'}</td><td className="px-6 py-4 text-slate-500 transition-colors">{r.owner}</td><td className="px-6 py-4 text-slate-400 uppercase font-black text-right transition-colors">{r.status}</td></tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="flex gap-6">
                                    <button onClick={() => setImportPreview(null)} className="flex-1 py-6 rounded-[2rem] bg-slate-100 dark:bg-slate-700 font-black uppercase text-xs text-slate-400 hover:bg-slate-200 transition-colors tracking-widest">Abort Ingestion</button>
                                    <button onClick={async () => {
                                        setIsProcessing(true); 
                                        const coll = dbInst.collection("artifacts").doc(currentAppId).collection("public").doc("data").collection("qc_tasks");
                                        
                                        if (importMode === 'overwrite' && overlappingCount > 0) {
                                            const importRefNos = new Set(importPreview.map(r => r.refNo).filter(Boolean));
                                            const docsToDelete = tasks.filter(t => importRefNos.has(t.refNo));
                                            for (let i = 0; i < docsToDelete.length; i += 500) {
                                                const batch = dbInst.batch();
                                                docsToDelete.slice(i, i+500).forEach(t => batch.delete(coll.doc(t.id)));
                                                await batch.commit();
                                            }
                                        }

                                        for (let i = 0; i < importPreview.length; i += 500) {
                                            const batch = dbInst.batch();
                                            importPreview.slice(i, i+500).forEach(t => {
                                                batch.set(coll.doc(), {...t, createdAt: Date.now(), updatedAt: Date.now(), updatedBy: activeUser});
                                            });
                                            await batch.commit();
                                        }
                                        
                                        logActivity("Batch Ingestion", `${importPreview.length} rows (${importMode})`, activeUser, "Imported from Excel"); 
                                        setImportPreview(null); setIsProcessing(false);
                                    }} className="flex-[2] py-6 rounded-[2rem] bg-blue-600 text-white font-black uppercase text-xs shadow-xl shadow-blue-600/30 flex items-center justify-center gap-3 hover:bg-blue-700 active:scale-95 transition-all tracking-widest transition-colors duration-300">
                                        {isProcessing ? <div className="w-4 h-4 border-2 border-white/20 border-t-white animate-spin rounded-full"></div> : null} PUSH TO CLOUD
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Final Mount
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker à¹€à¸£à¸´à¹ˆà¸¡à¸—à¸³à¸‡à¸²à¸™à¹à¸¥à¹‰à¸§!', reg.scope))
                    .catch(err => console.log('Service Worker à¸žà¸±à¸‡à¸ˆà¹‰à¸²: ', err));
            });
        }
    </script>
</body>
</html>